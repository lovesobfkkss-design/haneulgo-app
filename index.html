<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026ë…„ 1í•™ê¸° ì¤‘ê°„ê³ ì‚¬ - í•™ìƒ ìë£Œ ë°°ë¶€ ì²´í¬ë¦¬ìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            padding: 10px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        /* ==================== íƒ­ UI ==================== */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-bottom: 3px solid transparent;
            background: #f8f9fa;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }

        .tab-btn:hover {
            background: #e8f0fe;
            color: #3498db;
        }

        .tab-btn.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== ê³µí†µ ==================== */
        .week-info {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-selector input {
            width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .grade-section {
            margin-bottom: 30px;
        }

        .grade-header {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 0 0 8px 8px;
            border: 1px solid #ddd;
            border-top: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .student-name {
            font-weight: 500;
            white-space: nowrap;
        }

        .class-info {
            color: #7f8c8d;
            font-size: 14px;
        }

        .editable-class {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            border-bottom: 1px dashed #bbb;
        }

        .editable-class:hover {
            background: #e8f4fd;
            border-bottom-color: #3498db;
        }

        .editable-delivery {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            border-bottom: 1px dashed #bbb;
        }

        .editable-delivery:hover {
            background: #e8f4fd;
            border-bottom-color: #3498db;
        }

        .editable-payment {
            cursor: pointer;
            border-bottom: 1px dashed #bbb;
            transition: background 0.2s;
        }

        .editable-payment:hover {
            background: #e8f4fd;
            border-bottom-color: #3498db;
        }

        .class-input {
            padding: 4px 8px;
            border: 1px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
            width: 60px;
        }

        .subjects {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .subject-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .subject-tag:hover {
            background: #bbdefb;
        }

        .add-subject-btn {
            background: #f0f0f0;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px dashed #999;
        }

        .add-subject-btn:hover {
            background: #e0e0e0;
        }

        .subject-picker-btn {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #ffeeba;
        }

        .subject-picker-btn:hover {
            background: #ffe8a1;
        }

        .subject-input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 80px;
        }

        .delete-mode .subject-tag {
            background: #fee;
            color: #c33;
            position: relative;
        }

        .delete-mode .subject-tag::after {
            content: 'Ã—';
            margin-left: 5px;
            font-weight: bold;
        }

        .subject-overview {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .subject-overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
            user-select: none;
        }

        .subject-overview-header:hover {
            background: #e8f0fe;
        }

        .overview-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .overview-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .subject-overview-content {
            padding: 16px;
        }

        .subject-overview-content.hidden {
            display: none;
        }

        .subject-overview-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
        }

        .overview-filter-btn {
            padding: 5px 14px;
            border: 1px solid #ddd;
            border-radius: 16px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
        }

        .overview-filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .overview-filter-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .subject-overview-grades {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .subject-overview-grade {
            flex: 1;
            min-width: 280px;
        }

        .subject-overview-grade h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 14px;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
        }

        .subject-bars {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .subject-bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .subject-bar-name {
            width: 70px;
            text-align: right;
            color: #555;
            flex-shrink: 0;
        }

        .subject-bar-track {
            flex: 1;
            height: 22px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .subject-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
            min-width: 2px;
        }

        .subject-bar-fill.open { background: #3498db; }
        .subject-bar-fill.full { background: #e74c3c; }

        .subject-bar-count {
            width: 65px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .subject-bar-count.full {
            color: #e74c3c;
        }

        .payment-amount {
            font-size: 13px;
            color: #2c3e50;
            white-space: nowrap;
        }

        .phone {
            color: #7f8c8d;
            font-size: 14px;
            white-space: nowrap;
        }

        .checkbox-cell {
            text-align: left;
            vertical-align: middle;
        }

        .subjects-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subject-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subject-checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #27ae60;
            flex-shrink: 0;
        }

        .subject-checkbox-wrapper label {
            cursor: pointer;
            font-size: 14px;
            color: #2c3e50;
            user-select: none;
        }

        .subject-checkbox-wrapper input[type="checkbox"]:checked + label {
            color: #27ae60;
            font-weight: 500;
        }

        .completed-row {
            background: #e8f8f5;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            animation: fadeInOut 2s ease;
            z-index: 9999;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .reset-warning {
            background: #fee;
            border: 1px solid #fcc;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close-btn:hover {
            color: #000;
        }

        .delete-student-btn {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            margin-left: 10px;
        }

        .delete-student-btn:hover {
            background: #c0392b;
        }

        .edit-mode-active .delete-student-btn {
            display: inline-block;
        }

        .delete-student-btn {
            display: none;
        }

        .firebase-status {
            text-align: center;
            padding: 8px 16px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .firebase-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .firebase-status.disconnected {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .sms-btn {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            margin-left: 5px;
            white-space: nowrap;
        }

        .sms-btn:hover {
            background: #229954;
        }

        .sms-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* ==================== íƒ­2: ì‹ ì²­/ì…ê¸ˆ í˜„í™© ==================== */
        .status-toggle {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            margin: 0 auto;
        }

        .status-toggle.checked {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        .status-toggle:hover {
            border-color: #3498db;
            transform: scale(1.1);
        }

        /* ==================== íƒ­3: ì—‘ì…€ ì—…ë¡œë“œ ==================== */
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #3498db;
            background: #e8f4fd;
        }

        .upload-area-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-area-text {
            color: #666;
            font-size: 16px;
        }

        .upload-area-sub {
            color: #999;
            font-size: 13px;
            margin-top: 5px;
        }

        .preview-table {
            margin-top: 20px;
        }

        .preview-table table {
            font-size: 13px;
        }

        .preview-table th {
            background: #e8f4fd;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .duplicate-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }

        .student-management-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .management-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .management-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .management-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .parent-auth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .parent-auth-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .auth-method-btn.active {
            background: #1f6fb2;
            color: white;
        }

        .auth-note {
            font-size: 12px;
            color: #666;
        }

        .auth-alert {
            display: none;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .auth-alert.success {
            display: block;
            background: #e8f7ee;
            color: #1f7a3a;
            border: 1px solid #bfe5cc;
        }

        .auth-alert.error {
            display: block;
            background: #fdecea;
            color: #c0392b;
            border: 1px solid #f5b7b1;
        }

        .parent-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: #eef6ff;
            color: #2b6cb0;
            font-size: 13px;
            font-weight: 600;
        }

        .parent-student-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .parent-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .parent-subject {
            padding: 4px 8px;
            border-radius: 999px;
            background: #e8f4fd;
            color: #1c6ea4;
            font-size: 12px;
            font-weight: 600;
        }

        .parent-subject.checked {
            background: #d4edda;
            color: #1f7a3a;
        }

        .code-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #f1f4f9;
            font-size: 12px;
            font-weight: 600;
        }

        .code-expiring {
            color: #d35400;
            font-weight: 700;
        }

        .student-list-compact {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-list-compact table {
            font-size: 13px;
        }

        .subject-picker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 320px;
            overflow-y: auto;
            padding: 6px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }

        .subject-picker-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 999px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }

        .subject-picker-item input {
            width: 16px;
            height: 16px;
            accent-color: #3498db;
        }

        .subject-picker-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        /* ==================== ë°˜ì‘í˜• ==================== */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                border-radius: 8px;
            }

            h1 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .tab-nav {
                gap: 2px;
            }

            .tab-btn {
                padding: 10px 8px;
                font-size: 12px;
            }

            .week-info {
                gap: 10px;
            }

            .week-selector input {
                width: 140px;
                font-size: 16px;
            }

            .stats {
                gap: 8px;
            }

            .stat-card {
                min-width: 70px;
                padding: 8px 12px;
            }

            .stat-number {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .search-box {
                width: 100%;
                min-width: auto;
                font-size: 16px;
                padding: 12px;
            }

            .filter-buttons {
                width: 100%;
                justify-content: center;
            }

            .btn {
                padding: 10px 14px;
                font-size: 13px;
                min-height: 44px;
            }

            .grade-header {
                padding: 10px 15px;
                font-size: 16px;
            }

            table {
                font-size: 13px;
            }

            th, td {
                padding: 10px 6px;
                font-size: 13px;
            }

            th:first-child, td:first-child {
                width: 40px;
                text-align: center;
            }

            .student-name {
                font-size: 14px;
            }

            .class-info {
                font-size: 13px;
            }

            .subject-tag {
                font-size: 11px;
                padding: 4px 8px;
                margin-bottom: 2px;
            }

            .add-subject-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .phone {
                display: none;
            }

            .checkbox-cell {
                width: auto;
                min-width: 100px;
            }

            .subject-checkbox-wrapper {
                margin-bottom: 4px;
            }

            .subject-checkbox-wrapper input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }

            .subject-checkbox-wrapper label {
                font-size: 13px;
            }

            .delete-student-btn {
                padding: 6px 10px;
                font-size: 11px;
                margin-left: 5px;
                margin-top: 4px;
                display: block;
            }

            .sms-btn {
                padding: 6px 10px;
                font-size: 11px;
                margin-left: 5px;
                margin-top: 4px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 90%;
                max-width: 400px;
            }

            .modal-header {
                font-size: 18px;
            }

            .form-group input,
            .form-group select {
                font-size: 16px;
                padding: 12px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }

            .save-indicator {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                padding: 10px 16px;
                font-size: 14px;
            }

            .upload-area {
                padding: 25px 15px;
            }

            .upload-area-icon {
                font-size: 36px;
            }

            .upload-area-text {
                font-size: 14px;
            }

            .status-toggle {
                width: 32px;
                height: 32px;
            }

            .subject-picker-list {
                max-height: 240px;
            }

            .subject-picker-item {
                font-size: 12px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>2026ë…„ 1í•™ê¸° ì¤‘ê°„ê³ ì‚¬ - í•™ìƒ ìë£Œ ë°°ë¶€ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

        <div id="firebaseStatus" class="firebase-status" style="display: none;"></div>

        <div class="management-card" id="adminAuthCard">
            <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p>ê´€ë¦¬ìë§Œ í•™ìƒ ê´€ë¦¬/ë°°ë¶€ ì²´í¬ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="parent-auth-grid">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="adminPasswordSimple">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPasswordSimple" placeholder="ì˜ˆ: 1234">
                </div>
                <div class="parent-auth-actions">
                    <button class="btn btn-primary" type="button" onclick="adminPasswordLogin()">ë¡œê·¸ì¸</button>
                    <button class="btn btn-secondary" type="button" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="adminPasswordCurrent">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPasswordCurrent" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label for="adminPasswordNew">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPasswordNew" placeholder="4ì ì´ìƒ">
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label for="adminPasswordConfirm">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="adminPasswordConfirm" placeholder="ë‹¤ì‹œ ì…ë ¥">
                </div>
                <div class="parent-auth-actions" style="align-self:flex-end;">
                    <button class="btn btn-secondary" type="button" onclick="changeAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    <button class="btn btn-warning" type="button" onclick="resetAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div id="adminAuthAlert" class="auth-alert"></div>
        </div>

            <div class="management-card" id="codeSettingsCard">
                <h3>ì ‘ì† ì½”ë“œ ì„¤ì •</h3>
                <p>ì ‘ì† ì½”ë“œ ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                <div class="parent-auth-grid">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="codeTtlDays">ìœ íš¨ê¸°ê°„ (ì¼)</label>
                        <input type="number" id="codeTtlDays" min="1" max="365" value="30">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="codeExpiringDays">ì„ë°• ê¸°ì¤€ (ì¼)</label>
                        <input type="number" id="codeExpiringDays" min="1" max="60" value="7">
                    </div>
                    <div class="parent-auth-actions">
                        <button class="btn btn-primary" type="button" onclick="saveCodeTtl()">ì €ì¥</button>
                        <button class="btn btn-secondary" type="button" onclick="regenerateExpiredCodes()">ë§Œë£Œ ì½”ë“œ ì¬ìƒì„±</button>
                    </div>
                </div>
                <div class="auth-note" style="margin-top:6px;">ê¸°ì¡´ ì½”ë“œë„ ê¸°ì¤€ì¼ë¡œë¶€í„° ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
            </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab(1)">ë°°ë¶€ ì²´í¬</button>
            <button class="tab-btn" onclick="switchTab(2)">ì‹ ì²­/ì…ê¸ˆ</button>
            <button class="tab-btn" onclick="switchTab(5)">íƒë°°/í”½ì—…</button>
            <button class="tab-btn" onclick="switchTab(3)">í•™ìƒ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab(4)">í•™ë¶€ëª¨ ì¡°íšŒ</button>
        </div>

        <!-- ==================== ê³¼ëª©ë³„ ì‹ ì²­ í˜„í™© ==================== -->
        <div id="subjectOverview" class="subject-overview" style="display:none">
            <div class="subject-overview-header" onclick="toggleSubjectOverview()">
                <span>ê³¼ëª©ë³„ ì‹ ì²­ í˜„í™©</span>
                <span id="subjectOverviewToggle" class="overview-toggle">â–¼</span>
            </div>
            <div id="subjectOverviewContent" class="subject-overview-content">
                <div class="subject-overview-filter">
                    <button class="overview-filter-btn active" onclick="filterSubjectOverview('all')">ì „ì²´</button>
                    <button class="overview-filter-btn" onclick="filterSubjectOverview('íƒë°°')">íƒë°°</button>
                    <button class="overview-filter-btn" onclick="filterSubjectOverview('í”½ì—…')">í”½ì—…</button>
                </div>
                <div class="subject-overview-grades">
                    <div class="subject-overview-grade" id="subjectOverviewGrade1">
                        <h4>1í•™ë…„</h4>
                        <div class="subject-bars" id="subjectBarsGrade1"></div>
                    </div>
                    <div class="subject-overview-grade" id="subjectOverviewGrade2">
                        <h4>2í•™ë…„</h4>
                        <div class="subject-bars" id="subjectBarsGrade2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 1: ë§¤ì£¼ ë°°ë¶€ ì²´í¬ ==================== -->
        <div class="tab-content active" id="tab-1">
            <div class="auth-note" id="adminCheckNote" style="margin-bottom:10px; text-align:center;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì²´í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <div class="week-info">
                <div class="week-selector">
                    <label for="weekSelect">ì£¼ì°¨ ì„ íƒ:</label>
                    <input type="week" id="weekSelect" value="">
                </div>
                <button class="btn btn-primary" onclick="loadWeekData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="btn btn-secondary" onclick="resetWeek()">ì´ˆê¸°í™”</button>
            </div>

            <div id="resetWarning" class="reset-warning">
                ì •ë§ë¡œ ì´ë²ˆ ì£¼ì°¨ì˜ ëª¨ë“  ì²´í¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                <button class="btn btn-danger" onclick="confirmReset()">í™•ì¸</button>
                <button class="btn btn-secondary" onclick="cancelReset()">ì·¨ì†Œ</button>
            </div>

            <div class="stats" id="tab1Stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ì „ì²´ ê³¼ëª©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedCount">0</div>
                    <div class="stat-label">ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="remainingCount">0</div>
                    <div class="stat-label">ë¯¸ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">ì™„ë£Œìœ¨</div>
                </div>
            </div>

            <div class="controls">
                <input type="text" class="search-box" id="searchInput" placeholder="ì´ë¦„, ë°˜, ê³¼ëª©ìœ¼ë¡œ ê²€ìƒ‰...">
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="filterGrade('all')">ì „ì²´</button>
                    <button class="btn btn-secondary" onclick="filterGrade(1)">1í•™ë…„</button>
                    <button class="btn btn-secondary" onclick="filterGrade(2)">2í•™ë…„</button>
                    <select id="classFilter" class="search-box" onchange="filterByClass()" style="width: auto; min-width: 120px;">
                        <option value="all">ëª¨ë“  ë°˜</option>
                    </select>
                    <select id="deliveryFilter" class="search-box" onchange="filterByDelivery()" style="width: auto; min-width: 120px;">
                        <option value="all">ì „ì²´ ìˆ˜ë ¹</option>
                        <option value="íƒë°°">íƒë°°</option>
                        <option value="í”½ì—…">í”½ì—…</option>
                    </select>
                    <button class="btn btn-success" onclick="checkAll()">ì „ì²´ ì²´í¬</button>
                    <button class="btn btn-secondary" onclick="uncheckAll()">ì „ì²´ í•´ì œ</button>
                    <button class="btn btn-primary" onclick="toggleEditMode(event)">ê³¼ëª© í¸ì§‘</button>
                    <button class="btn btn-success" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-success" onclick="openBulkSMSModal()">ì „ì²´ ë¬¸ì ë³´ë‚´ê¸°</button>
                </div>
            </div>

            <div class="grade-section" id="grade1Section">
                <div class="grade-header">
                    <span>1í•™ë…„</span>
                    <span id="grade1Stats">0/0 ì™„ë£Œ</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ìˆ˜ë ¹</th>
                                <th class="phone">í•™ìƒ ì „í™”ë²ˆí˜¸</th>
                                <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th>ì…ê¸ˆí™•ì¸</th>
                                <th>ë°°ë¶€ì™„ë£Œ</th>
                            </tr>
                        </thead>
                        <tbody id="grade1Body"></tbody>
                    </table>
                </div>
            </div>

            <div class="grade-section" id="grade2Section">
                <div class="grade-header">
                    <span>2í•™ë…„</span>
                    <span id="grade2Stats">0/0 ì™„ë£Œ</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ìˆ˜ë ¹</th>
                                <th class="phone">í•™ìƒ ì „í™”ë²ˆí˜¸</th>
                                <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th>ì…ê¸ˆí™•ì¸</th>
                                <th>ë°°ë¶€ì™„ë£Œ</th>
                            </tr>
                        </thead>
                        <tbody id="grade2Body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 2: ì‹ ì²­/ì…ê¸ˆ í˜„í™© ==================== -->
        <div class="tab-content" id="tab-2">
            <div class="stats" id="tab2Stats">
                <div class="stat-card">
                    <div class="stat-number" id="tab2TotalCount">0</div>
                    <div class="stat-label">ì „ì²´ í•™ìƒ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab2CashReceiptCount">0</div>
                    <div class="stat-label">í˜„ê¸ˆì˜ìˆ˜ì¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab2MobileUrlCount">0</div>
                    <div class="stat-label">ëª¨ë°”ì¼URL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab2ShippingFeeCount">0</div>
                    <div class="stat-label">íƒë°°ë¹„ ë‚©ë¶€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab2PaymentCount">0</div>
                    <div class="stat-label">ì…ê¸ˆí™•ì¸</div>
                </div>
            </div>

            <div class="controls">
                <input type="text" class="search-box" id="tab2SearchInput" placeholder="ì´ë¦„, ë°˜, ê³¼ëª©ìœ¼ë¡œ ê²€ìƒ‰...">
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="filterGradeTab2('all')">ì „ì²´</button>
                    <button class="btn btn-secondary" onclick="filterGradeTab2(1)">1í•™ë…„</button>
                    <button class="btn btn-secondary" onclick="filterGradeTab2(2)">2í•™ë…„</button>
                    <select id="tab2ClassFilter" class="search-box" onchange="filterByClassTab2()" style="width: auto; min-width: 120px;">
                        <option value="all">ëª¨ë“  ë°˜</option>
                    </select>
                    <select id="tab2DeliveryFilter" class="search-box" onchange="filterByDeliveryTab2()" style="width: auto; min-width: 120px;">
                        <option value="all">ì „ì²´ ìˆ˜ë ¹</option>
                        <option value="íƒë°°">íƒë°°</option>
                        <option value="í”½ì—…">í”½ì—…</option>
                    </select>
                </div>
            </div>

            <div class="grade-section" id="tab2Grade1Section">
                <div class="grade-header">
                    <span>1í•™ë…„</span>
                    <span id="tab2Grade1Stats">0ëª…</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ìˆ˜ë ¹</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th style="text-align:center;">íƒë°°ë¹„</th>
                                <th style="text-align:center;">í˜„ê¸ˆì˜ìˆ˜ì¦</th>
                                <th style="text-align:center;">ëª¨ë°”ì¼URL</th>
                                <th style="text-align:center;">ì…ê¸ˆí™•ì¸</th>
                            </tr>
                        </thead>
                        <tbody id="tab2Grade1Body"></tbody>
                    </table>
                </div>
            </div>

            <div class="grade-section" id="tab2Grade2Section">
                <div class="grade-header">
                    <span>2í•™ë…„</span>
                    <span id="tab2Grade2Stats">0ëª…</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ìˆ˜ë ¹</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th style="text-align:center;">íƒë°°ë¹„</th>
                                <th style="text-align:center;">í˜„ê¸ˆì˜ìˆ˜ì¦</th>
                                <th style="text-align:center;">ëª¨ë°”ì¼URL</th>
                                <th style="text-align:center;">ì…ê¸ˆí™•ì¸</th>
                            </tr>
                        </thead>
                        <tbody id="tab2Grade2Body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 3: í•™ìƒ ê´€ë¦¬ ==================== -->
        <div class="tab-content" id="tab-3">
            <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="management-card">
                <h3>ì—‘ì…€ íŒŒì¼ë¡œ í•™ìƒ ì¼ê´„ ì¶”ê°€</h3>
                <p>.xlsx, .xls, .csv íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í•™ìƒì„ ì¼ê´„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                   ì—‘ì…€ ì»¬ëŸ¼: ì´ë¦„, í•™ë…„, ë°˜, ê³¼ëª©(ì‰¼í‘œ ë˜ëŠ” | êµ¬ë¶„), ìˆ˜ë ¹(í”½ì—…/íƒë°°), í•™ìƒ ì „í™”ë²ˆí˜¸, í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸, ì ‘ì† ì½”ë“œ(ì„ íƒ)</p>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-area-icon">ğŸ“</div>
                    <div class="upload-area-text">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
                    <div class="upload-area-sub">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</div>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;">
                </div>

                <div id="excelPreview" style="display:none;">
                    <h4 style="margin-bottom:10px;">ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°</h4>
                    <div id="duplicateWarning" class="duplicate-warning" style="display:none;"></div>
                    <div class="preview-table" id="previewTableContainer"></div>
                    <div class="preview-actions">
                        <button class="btn btn-secondary" onclick="cancelExcelUpload()">ì·¨ì†Œ</button>
                        <button class="btn btn-success" onclick="confirmExcelUpload()">í•™ìƒ ì¶”ê°€ í™•ì •</button>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ìˆ˜ë™ ì¶”ê°€ -->
            <div class="management-card">
                <h3>í•™ìƒ ê°œë³„ ì¶”ê°€</h3>
                <p>í•™ìƒ í•œ ëª…ì„ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="openAddStudentModal()">+ í•™ìƒ ì¶”ê°€</button>
            </div>

            <!-- í•™ìƒ ëª©ë¡ ë° í¸ì§‘ -->
            <div class="management-card">
                <h3>í˜„ì¬ ë“±ë¡ëœ í•™ìƒ (<span id="tab3StudentCount">0</span>ëª…)</h3>
                <p>í•™ìƒ ì‚­ì œ ë° ê³¼ëª© í¸ì§‘ì€ í¸ì§‘ ëª¨ë“œì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                <div style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap;">
                    <input type="text" id="tab3SearchInput" class="search-box" placeholder="ì´ë¦„/ì ‘ì† ì½”ë“œ ê²€ìƒ‰" style="flex:1;">
                    <select id="tab3CodeFilter" class="search-box" style="max-width:220px;">
                        <option value="all">ì½”ë“œ ì „ì²´</option>
                        <option value="expired">ë§Œë£Œëœ ì½”ë“œ</option>
                        <option value="expiring">ë§Œë£Œ ì„ë°• (ê¸°ì¤€ì¼ ì´ë‚´)</option>
                    </select>
                </div>
                <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="toggleEditModeTab3()">ê³¼ëª©/í•™ìƒ í¸ì§‘</button>
                    <button class="btn btn-danger" onclick="resetToDefaultStudents()">í•™ìƒ ë°ì´í„° ì´ˆê¸°í™”</button>
                    <button class="btn btn-warning" onclick="clearAllStudents()">í•™ìƒ ì „ì²´ ì‚­ì œ</button>
                </div>

                <div class="student-list-compact">
                    <div class="grade-section" id="tab3Grade1Section" style="margin-bottom:15px;">
                        <div class="grade-header" style="font-size:15px; padding:8px 15px;">
                            <span>1í•™ë…„</span>
                            <span id="tab3Grade1Count">0ëª…</span>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ë²ˆí˜¸</th>
                                        <th>ì´ë¦„</th>
                                        <th>ë°˜</th>
                                        <th>ì‹ ì²­ ê³¼ëª©</th>
                                        <th>ìˆ˜ë ¹</th>
                                        <th class="phone">í•™ìƒ ì „í™”ë²ˆí˜¸</th>
                                        <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                                        <th>ì ‘ì† ì½”ë“œ</th>
                                        <th>ë§Œë£Œì¼</th>
                                    </tr>
                                </thead>
                                <tbody id="tab3Grade1Body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="grade-section" id="tab3Grade2Section">
                        <div class="grade-header" style="font-size:15px; padding:8px 15px;">
                            <span>2í•™ë…„</span>
                            <span id="tab3Grade2Count">0ëª…</span>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ë²ˆí˜¸</th>
                                        <th>ì´ë¦„</th>
                                        <th>ë°˜</th>
                                        <th>ì‹ ì²­ ê³¼ëª©</th>
                                        <th>ìˆ˜ë ¹</th>
                                        <th class="phone">í•™ìƒ ì „í™”ë²ˆí˜¸</th>
                                        <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                                        <th>ì ‘ì† ì½”ë“œ</th>
                                        <th>ë§Œë£Œì¼</th>
                                    </tr>
                                </thead>
                                <tbody id="tab3Grade2Body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 5: íƒë°°/í”½ì—… ê´€ë¦¬ ==================== -->
        <div class="tab-content" id="tab-5">
            <div class="stats" id="tab5Stats">
                <div class="stat-card">
                    <div class="stat-number" id="tab5DeliveryCount">0</div>
                    <div class="stat-label">íƒë°°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab5PickupCount">0</div>
                    <div class="stat-label">í”½ì—…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab5ShippingPaid">0/0</div>
                    <div class="stat-label">íƒë°°ë¹„ ë‚©ë¶€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tab5ShippingUnpaid">0</div>
                    <div class="stat-label">íƒë°°ë¹„ ë¯¸ë‚©</div>
                </div>
            </div>

            <div class="grade-section" id="tab5DeliverySection">
                <div class="grade-header">
                    <span>íƒë°° í•™ìƒ</span>
                    <span id="tab5DeliveryStats">0ëª…</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>í•™ë…„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th style="text-align:center;">íƒë°°ë¹„ ë‚©ë¶€</th>
                                <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                            </tr>
                        </thead>
                        <tbody id="tab5DeliveryBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="grade-section" id="tab5PickupSection">
                <div class="grade-header">
                    <span>í”½ì—… í•™ìƒ</span>
                    <span id="tab5PickupStats">0ëª…</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>í•™ë…„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                            </tr>
                        </thead>
                        <tbody id="tab5PickupBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="grade-section" id="tab5NoneSection">
                <div class="grade-header">
                    <span>ë¯¸ì§€ì • í•™ìƒ</span>
                    <span id="tab5NoneStats">0ëª…</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>í•™ë…„</th>
                                <th>ë°˜</th>
                                <th>ì‹ ì²­ ê³¼ëª©</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th class="phone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th>
                            </tr>
                        </thead>
                        <tbody id="tab5NoneBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 4: í•™ë¶€ëª¨ ì¡°íšŒ ==================== -->
        <div class="tab-content" id="tab-4">
            <div class="management-card">
                <h3>í•™ë¶€ëª¨/í•™ìƒ ì¡°íšŒ</h3>
                <p>í•™ìƒì—ê²Œ ë°›ì€ ì ‘ì† ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë°°ë¶€ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="parent-auth-grid">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="parentAccessCode">ì ‘ì† ì½”ë“œ</label>
                        <input type="text" id="parentAccessCode" placeholder="ì˜ˆ: 8ìë¦¬ ì½”ë“œ">
                    </div>
                    <div class="parent-auth-actions">
                        <button class="btn btn-primary" type="button" onclick="lookupStudentByCode()">ì¡°íšŒ</button>
                    </div>
                </div>
                <div class="auth-note" id="parentCodeNote" style="margin-top:6px;">ì½”ë“œëŠ” 30ì¼ ë™ì•ˆ ìœ íš¨í•©ë‹ˆë‹¤.</div>
            </div>

            <div class="management-card">
                <h3>ë°°ë¶€ í˜„í™©</h3>
                <div id="parentViewStatus" class="auth-note" style="margin-bottom:8px;">ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                <div id="parentLinkedList" style="display:none; margin-bottom:12px;"></div>
                <div class="week-info" style="margin-bottom:15px;">
                    <div class="week-selector">
                        <label for="parentWeekSelect">ì£¼ì°¨ ì„ íƒ:</label>
                        <input type="week" id="parentWeekSelect" value="">
                    </div>
                </div>

                <div id="parentStudentsEmpty" style="display:none; color:#888; text-align:center; padding:10px 0;">
                    ì—°ê²°ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
                </div>
                <div id="parentStudentsList"></div>
            </div>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        âœ“ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <!-- í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddStudentModal()">&times;</span>
            <div class="modal-header">í•™ìƒ ì¶”ê°€</div>
            <form id="addStudentForm" onsubmit="addStudent(event)">
                <div class="form-group">
                    <label for="studentName">ì´ë¦„ *</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentGrade">í•™ë…„ *</label>
                    <select id="studentGrade" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentClass">ë°˜ *</label>
                    <input type="text" id="studentClass" placeholder="ì˜ˆ: 1ë°˜, 2ë°˜" required>
                </div>
                <div class="form-group">
                    <label for="studentSubjects">ì‹ ì²­ ê³¼ëª© *</label>
                    <input type="text" id="studentSubjects" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: êµ­ì–´, ì˜ì–´, ìˆ˜í•™)" required>
                </div>
                <div class="form-group">
                    <label for="studentDelivery">ìˆ˜ë ¹ ë°©ì‹</label>
                    <select id="studentDelivery">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                        <option value="í”½ì—…">í”½ì—…</option>
                        <option value="íƒë°°">íƒë°°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentPhone">í•™ìƒ ì „í™”ë²ˆí˜¸</label>
                    <input type="tel" id="studentPhone" placeholder="010-xxxx-xxxx">
                </div>
                <div class="form-group">
                    <label for="parentPhone">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ (ì—¬ëŸ¬ ê°œëŠ” ì‰¼í‘œ/|ë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="parentPhone" placeholder="010-xxxx-xxxx, 010-yyyy-yyyy">
                </div>
                <div class="form-group">
                    <label for="accessCode">ì ‘ì† ì½”ë“œ (ì—†ìœ¼ë©´ ìë™ ìƒì„±)</label>
                    <input type="text" id="accessCode" placeholder="ì˜ˆ: 8ìë¦¬ ì½”ë“œ">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddStudentModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-success">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì „ì²´ ë¬¸ì ë³´ë‚´ê¸° ëª¨ë‹¬ -->
    <div id="bulkSMSModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBulkSMSModal()">&times;</span>
            <div class="modal-header">ì „ì²´ ë¬¸ì ë³´ë‚´ê¸°</div>
            <div style="margin-bottom: 20px;">
                <p style="margin-bottom: 15px; color: #555;">ì–´ë–¤ í•™ìƒë“¤ì˜ í•™ë¶€ëª¨ì—ê²Œ ë¬¸ìë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="sendBulkSMS('all')">
                    ëª¨ë“  í•™ìƒ í•™ë¶€ëª¨ (<span id="allParentsCount">0</span>ëª…)
                </button>
                <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="sendBulkSMS('completed')">
                    ë°°ë¶€ ì™„ë£Œëœ í•™ìƒ í•™ë¶€ëª¨ (<span id="completedParentsCount">0</span>ëª…)
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="sendBulkSMS('incomplete')">
                    ë°°ë¶€ ë¯¸ì™„ë£Œ í•™ìƒ í•™ë¶€ëª¨ (<span id="incompleteParentsCount">0</span>ëª…)
                </button>
                <p style="margin-top: 15px; font-size: 12px; color: #888;">
                    ë¬¸ì ì•±ì´ ì—´ë¦¬ê³  ìˆ˜ì‹ ìê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. ì „ì†¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ìë¥¼ ë³´ë‚´ì„¸ìš”.
                </p>
            </div>
        </div>
    </div>

    <!-- ê°œë³„ ë¬¸ì ë³´ë‚´ê¸° ëª¨ë‹¬ -->
    <div id="smsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSMSModal()">&times;</span>
            <div class="modal-header">ë¬¸ì ë³´ë‚´ê¸°</div>
            <div id="smsStudentInfo" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            </div>
            <div class="form-group">
                <label for="smsMessage">ë©”ì‹œì§€ ë‚´ìš©</label>
                <textarea id="smsMessage" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                <p style="margin-top: 5px; font-size: 12px; color: #888;">
                    ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: {ì´ë¦„}, {í•™ë…„}, {ë°˜}, {ê³¼ëª©}
                </p>
            </div>
            <div class="form-group">
                <label>ë©”ì‹œì§€ í…œí”Œë¦¿</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                    <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;" onclick="setMessageTemplate('complete')">ë°°ë¶€ ì™„ë£Œ</button>
                    <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;" onclick="setMessageTemplate('pickup')">ìˆ˜ë ¹ ìš”ì²­</button>
                    <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;" onclick="setMessageTemplate('reminder')">ìˆ˜ë ¹ ë…ì´‰</button>
                    <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;" onclick="setMessageTemplate('custom')">ì§ì ‘ ì…ë ¥</button>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSMSModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="sendSMSFromModal()">ë¬¸ì ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³¼ëª© ì„ íƒ ëª¨ë‹¬ -->
    <div id="subjectPickerModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSubjectPicker()">&times;</span>
            <div class="modal-header">ê³¼ëª© ì„ íƒ</div>
            <div class="form-group">
                <label for="subjectPickerSearch">ê³¼ëª© ê²€ìƒ‰</label>
                <input type="text" id="subjectPickerSearch" placeholder="ê³¼ëª©ëª… ê²€ìƒ‰">
            </div>
            <div class="subject-picker-actions">
                <button type="button" class="btn btn-secondary" onclick="selectAllSubjects()">ì „ì²´ ì„ íƒ</button>
                <button type="button" class="btn btn-secondary" onclick="clearAllSubjects()">ì „ì²´ í•´ì œ</button>
            </div>
            <div id="subjectPickerList" class="subject-picker-list"></div>
            <div class="form-group" style="margin-top: 15px;">
                <label for="customSubjectInput">ìƒˆ ê³¼ëª© ì¶”ê°€</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="customSubjectInput" placeholder="ê³¼ëª©ëª… ì…ë ¥" style="flex:1;">
                    <button type="button" class="btn btn-primary" onclick="addCustomSubjectToPicker()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSubjectPicker()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="applySubjectPicker()">ì„ íƒ ì ìš©</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase ì„¤ì • ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAUP6kiD3oUjrm3nUI4WuXoude-bGipYp0",
            authDomain: "sky-check.firebaseapp.com",
            databaseURL: "https://sky-check-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sky-check",
            storageBucket: "sky-check.firebasestorage.app",
            messagingSenderId: "387978624866",
            appId: "1:387978624866:web:f115730b2131d9df50363b"
        };

        // Firebase ì´ˆê¸°í™”
        let database = null;
        let useFirebase = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                useFirebase = true;
                console.log("âœ… Firebase ì—°ê²° ì„±ê³µ!");
                updateFirebaseStatus(true);
            } else {
                console.warn("âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                updateFirebaseStatus(false);
            }
        } catch (error) {
            console.error("âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            useFirebase = false;
            updateFirebaseStatus(false);
        }

        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!statusElement) return;

            statusElement.style.display = 'block';

            if (connected) {
                statusElement.className = 'firebase-status connected';
                statusElement.innerHTML = 'ğŸ”¥ Firebase ì—°ê²°ë¨ - ëª¨ë“  ê¸°ê¸°ì—ì„œ ì‹¤ì‹œê°„ ë™ê¸°í™”';
            } else {
                statusElement.className = 'firebase-status disconnected';
                statusElement.innerHTML = 'âš ï¸ localStorage ëª¨ë“œ - ì´ ê¸°ê¸°ì—ì„œë§Œ ì €ì¥ë¨';
            }
        }

        // ==================== ì´ˆê¸° í•™ìƒ ë°ì´í„° (ë°±ì—…ìš©) ====================
        const defaultStudents = [
            // 1í•™ë…„ 1ë°˜
            {grade: 1, num: 1, name: "ì •ìˆ˜ë¹ˆ", class: "1ë°˜", subjects: ["ì˜ì–´", "êµ­ì–´", "ê³¼í•™"], phone: "010-2747-9958", parentPhone: "010-3882-1103", deliveryType: "", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 2, name: "ì†ì˜ˆì¸", class: "1ë°˜", subjects: ["ì˜ì–´"], phone: "010-9639-0955", parentPhone: "010-4907-0955", deliveryType: "", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 3, name: "ì‹ ì„œìœ¤", class: "1ë°˜", subjects: ["ê³¼í•™"], phone: "010-9110-8978", parentPhone: "010-4945-8978", deliveryType: "", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 2ë°˜
            {grade: 1, num: 4, name: "êµ­ìœ¤", class: "2ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ê³¼í•™"], phone: "010-5027-9384", parentPhone: "010-8876-7658", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 5, name: "ì´í•„ë¦½", class: "2ë°˜", subjects: ["ì˜ì–´", "ìˆ˜í•™"], phone: "010-3565-9956", parentPhone: "010-6361-2340", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 6, name: "ìœ¤í•˜ì˜", class: "2ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™"], phone: "010-9304-4665", parentPhone: "010-2859-4665", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 7, name: "ë³€ì„œí˜„", class: "2ë°˜", subjects: ["ê³¼í•™"], phone: "010-4051-6964", parentPhone: "010-3808-6964", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 8, name: "ì‹ ì´ë‘", class: "2ë°˜", subjects: ["êµ­ì–´", "ê³¼í•™", "ì˜ì–´"], phone: "010-2363-8696", parentPhone: "010-4819-8696", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 9, name: "ê¹€ì§€ìš°", class: "2ë°˜", subjects: ["ìˆ˜í•™"], phone: "010-4263-6632", parentPhone: "010-6632-4588", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 3ë°˜
            {grade: 1, num: 10, name: "ìœ í•˜ì€", class: "3ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ê³¼í•™"], phone: "010-2768-8936", parentPhone: "010-8868-1807", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 11, name: "ì´ì˜ˆë‚˜", class: "3ë°˜", subjects: ["ì˜ì–´"], phone: "010-2705-6569", parentPhone: "010-3269-6569", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 12, name: "ì†¡ì •ì›", class: "3ë°˜", subjects: ["ì˜ì–´"], phone: "010-9045-7567", parentPhone: "010-8899-7567", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 13, name: "ì¥ì„œì˜", class: "3ë°˜", subjects: ["ìˆ˜í•™"], phone: "010-4272-4793", parentPhone: "010-4772-4793", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 4ë°˜
            {grade: 1, num: 14, name: "ê¹€ì§€ìš°", class: "4ë°˜", subjects: ["ì˜ì–´", "êµ­ì–´"], phone: "010-8684-9098", parentPhone: "010-9461-9098", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 15, name: "ì´ìš©ì¤€", class: "4ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™"], phone: "010-8393-3609", parentPhone: "010-8983-3609", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 16, name: "ê¶Œì§€í›„", class: "4ë°˜", subjects: ["ì˜ì–´"], phone: "010-2125-9402", parentPhone: "010-9403-9420", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 17, name: "ì£¼ì´í˜„", class: "4ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-9167-5220", parentPhone: "010-3365-5220", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 18, name: "ê¹€ìì¸", class: "4ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-2230-9751", parentPhone: "010-8861-9751", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 19, name: "ì´ê°•ìš°", class: "4ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™"], phone: "010-8831-7844", parentPhone: "010-9199-0108", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 20, name: "ì¡°ì˜ˆìŠ¹", class: "4ë°˜", subjects: ["ê³¼í•™"], phone: "010-2899-4934", parentPhone: "010-9344-1131", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 5ë°˜
            {grade: 1, num: 21, name: "ê¹€ì‹œí—Œ", class: "5ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-8108-9822", parentPhone: "010-3293-9822", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 22, name: "ê¹€ì±„ì€", class: "5ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™"], phone: "010-7128-5998", parentPhone: "010-4932-5998", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 6ë°˜
            {grade: 1, num: 23, name: "ë¬¸íš¨ì£¼", class: "6ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-4998-8415", parentPhone: "010-3639-8415", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 24, name: "ë°•í˜„ì„œ", class: "6ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-6488-2086", parentPhone: "010-3284-2086", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 25, name: "ìš°í˜„ì„œ", class: "6ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™"], phone: "010-2070-1419", parentPhone: "010-4794-1419", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 26, name: "ì†¡ë¯¼ì¤€", class: "6ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-2642-0046", parentPhone: "010-6734-0527", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 27, name: "ì¥ê·¼í˜", class: "6ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™"], phone: "010-8081-7940", parentPhone: "010-8952-7940", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 7ë°˜
            {grade: 1, num: 28, name: "ì´ì§€ì›", class: "7ë°˜", subjects: ["êµ­ì–´", "ìˆ˜í•™"], phone: "010-3176-0963", parentPhone: "010-4705-4477", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 29, name: "ì–‘ì„œì—°", class: "7ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-5428-7641", parentPhone: "010-2757-7641", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 30, name: "ìœ ë¯¼ì •", class: "7ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-2999-8688", parentPhone: "010-2999-8688", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 31, name: "ì´í˜„ì„œ", class: "7ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-9326-3312", parentPhone: "010-7384-1228", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 32, name: "ë°•ì˜ˆë‹´", class: "7ë°˜", subjects: ["êµ­ì–´"], phone: "010-6512-5365", parentPhone: "010-6312-5365", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 1í•™ë…„ 8ë°˜
            {grade: 1, num: 33, name: "ê¹€ë³´í˜„", class: "8ë°˜", subjects: ["ì˜ì–´"], phone: "010-4641-9367", parentPhone: "010-4641-9367", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 34, name: "ì„œì§€ìš°", class: "8ë°˜", subjects: ["êµ­ì–´", "ì˜ì–´"], phone: "010-4002-8568", parentPhone: "010-9167-8568", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 35, name: "í•œìˆ˜ë¯¼", class: "8ë°˜", subjects: ["ê³¼í•™"], phone: "010-5573-4761", parentPhone: "010-2018-4761", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            {grade: 1, num: 36, name: "ìš°ì„œì—°", class: "8ë°˜", subjects: ["ìˆ˜í•™"], phone: "010-3862-2871", parentPhone: "010-9189-5547", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 2í•™ë…„ 1ë°˜
            {grade: 2, num: 1, name: "ê¹€í•˜ìœ¤", class: "1ë°˜", subjects: ["ì˜ì–´"], phone: "010-5709-3790", parentPhone: "010-2752-3790", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 2í•™ë…„ 4ë°˜
            {grade: 2, num: 2, name: "ì „ì„œìœ¤", class: "4ë°˜", subjects: ["ì˜ì–´"], phone: "010-9116-0661", parentPhone: "010-9116-0661", cashReceipt: false, mobileUrl: false, paymentConfirmed: false},
            // 2í•™ë…„ 5ë°˜
            {grade: 2, num: 3, name: "ê¹€ë¼í¬", class: "5ë°˜", subjects: ["ì˜ì–´"], phone: "010-6575-1979", parentPhone: "010-6575-1979", cashReceipt: false, mobileUrl: false, paymentConfirmed: false}
        ];

        // í˜„ì¬ ì‘ì—…ì¤‘ì¸ í•™ìƒ ë°°ì—´
        const students = [];

        let currentWeek = '';
        let checkedStudents = {};
        let editMode = false;
        let editModeTab3 = false;
        let editingStudent = null;
        let currentTab = 1;
        let currentSubjectPickerStudentId = null;
        let parentViewStudents = [];
        let parentCheckedByStudent = {};
        let isAdmin = false;
        const DEFAULT_ADMIN_PASSWORD = '1234';
        let adminPassword = DEFAULT_ADMIN_PASSWORD;

        // ì—‘ì…€ ì—…ë¡œë“œ ì„ì‹œ ë°ì´í„°
        let pendingExcelStudents = [];
        let pendingExcelUpdatedCount = 0;

        const defaultSubjectPool = [
            'êµ­ì–´', 'ì˜ì–´', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‚¬íšŒ', 'í•œêµ­ì‚¬',
            'ìœ¤ë¦¬', 'ë¬¼ë¦¬', 'í™”í•™', 'ìƒëª…ê³¼í•™', 'ì§€êµ¬ê³¼í•™',
            'ì •ë³´', 'ê¸°ìˆ ê°€ì •', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ',
            'í”„ë‘ìŠ¤ì–´', 'ì¤‘êµ­ì–´', 'ì¼ë³¸ì–´'
        ];

        // ==================== íƒ­ ì „í™˜ ====================
        // íƒ­ ë²„íŠ¼ ìˆœì„œì™€ íƒ­ ID ë§¤í•‘
        const tabButtonOrder = [1, 2, 5, 3, 4];

        function switchTab(tabId, silent = false) {
            if (!isAdmin && tabId === 4) {
                // í•™ë¶€ëª¨ ì¡°íšŒëŠ” ëˆ„êµ¬ë‚˜ ê°€ëŠ¥
            } else if (!isAdmin && tabId !== 4) {
                if (!silent) {
                    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
                tabId = 4;
            }
            currentTab = tabId;

            // íƒ­ ë²„íŠ¼ ìƒíƒœ
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', tabButtonOrder[i] === tabId);
            });

            // íƒ­ ì½˜í…ì¸  ìƒíƒœ
            document.querySelectorAll('.tab-content').forEach(content => {
                const contentId = parseInt(content.id.replace('tab-', ''));
                content.classList.toggle('active', contentId === tabId);
            });

            // íƒ­ ì „í™˜ ì‹œ í•„ìš”í•œ ë Œë”ë§
            if (tabId === 2) {
                renderTab2();
            } else if (tabId === 3) {
                renderTab3();
            } else if (tabId === 4) {
                renderParentView();
            } else if (tabId === 5) {
                renderTab5();
            }
        }

        // ==================== ì´ˆê¸° ì„¤ì • ====================
        window.onload = function() {
            const now = new Date();
            const weekNumber = getWeekNumber(now);
            const year = now.getFullYear();
            document.getElementById('weekSelect').value = `${year}-W${weekNumber.toString().padStart(2, '0')}`;
            document.getElementById('parentWeekSelect').value = `${year}-W${weekNumber.toString().padStart(2, '0')}`;

            loadStudentsData(() => {
                loadWeekData();
            });

            document.getElementById('searchInput').addEventListener('input', searchStudents);
            document.getElementById('tab2SearchInput').addEventListener('input', searchStudentsTab2);
            document.getElementById('tab3SearchInput').addEventListener('input', searchStudentsTab3);
            document.getElementById('tab3CodeFilter').addEventListener('change', searchStudentsTab3);
            document.getElementById('subjectPickerSearch').addEventListener('input', filterSubjectPickerList);

            // ì—‘ì…€ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            setupExcelUpload();
            setupParentView();
            setupCodeTtl();
            setupAdminPassword();
        };

        // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupFirebaseListeners() {
            database.ref('students').on('value', (snapshot) => {
                let savedData = snapshot.val();
                if (savedData && Array.isArray(savedData) && savedData.length > 0) {
                    savedData.forEach(s => { if (!Array.isArray(s.subjects)) s.subjects = []; });
                    if (JSON.stringify(students) !== JSON.stringify(savedData)) {
                        students.length = 0;
                        students.push(...savedData);
                        const fieldsChanged = ensureNewFields();
                        const changed = ensureStudentIds();
                        if (fieldsChanged || changed) saveStudentsData();
                        renderStudents();
                        if (currentTab === 2) renderTab2();
                        if (currentTab === 3) renderTab3();
                        console.log("ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”: í•™ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸ë¨");
                    }
                }
            });

            database.ref('checkedStudents').on('value', (snapshot) => {
                const savedData = snapshot.val();
                if (savedData) {
                    const normalized = normalizeCheckedStudents(savedData);
                    if (JSON.stringify(checkedStudents) !== JSON.stringify(normalized)) {
                        checkedStudents = normalized;
                        renderStudents();
                        console.log("ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”: ì²´í¬ ë°ì´í„° ì—…ë°ì´íŠ¸ë¨");
                    }
                }
            });

            console.log("âœ… Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”ë¨!");
        }

        // ==================== í•™ë¶€ëª¨ ì¡°íšŒ (ì½”ë“œ ì…ë ¥) ====================
        function setupParentView() {
            document.getElementById('parentWeekSelect').addEventListener('change', renderParentView);
        }

        function setupCodeTtl() {
            const stored = localStorage.getItem('accessCodeTtlDays');
            if (stored) {
                const parsed = parseInt(stored, 10);
                if (!Number.isNaN(parsed) && parsed > 0) {
                    ACCESS_CODE_TTL_DAYS = parsed;
                }
            }
            const expiringStored = localStorage.getItem('accessCodeExpiringDays');
            if (expiringStored) {
                const parsed = parseInt(expiringStored, 10);
                if (!Number.isNaN(parsed) && parsed > 0) {
                    ACCESS_CODE_EXPIRING_DAYS = parsed;
                }
            }
            document.getElementById('codeTtlDays').value = ACCESS_CODE_TTL_DAYS;
            document.getElementById('codeExpiringDays').value = ACCESS_CODE_EXPIRING_DAYS;
            updateParentCodeNote();
        }

        function saveCodeTtl() {
            const input = document.getElementById('codeTtlDays');
            const value = parseInt(input.value, 10);
            const expInput = document.getElementById('codeExpiringDays');
            const expValue = parseInt(expInput.value, 10);
            if (Number.isNaN(value) || value < 1 || value > 365) {
                alert('ìœ íš¨ê¸°ê°„ì€ 1~365 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (Number.isNaN(expValue) || expValue < 1 || expValue > 60) {
                alert('ì„ë°• ê¸°ì¤€ì€ 1~60 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            ACCESS_CODE_TTL_DAYS = value;
            ACCESS_CODE_EXPIRING_DAYS = expValue;
            localStorage.setItem('accessCodeTtlDays', String(value));
            localStorage.setItem('accessCodeExpiringDays', String(expValue));
            updateParentCodeNote();
            showSaveIndicator();
            if (isAdmin) {
                ensureNewFields();
                saveStudentsData();
                renderTab3();
            }
        }

        function updateParentCodeNote() {
            const note = document.getElementById('parentCodeNote');
            if (note) {
                note.textContent = `ì½”ë“œëŠ” ${ACCESS_CODE_TTL_DAYS}ì¼ ë™ì•ˆ ìœ íš¨í•©ë‹ˆë‹¤. ì—°ê²° í›„ì—ëŠ” ë¡œê·¸ì¸ë§Œìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤.`;
            }
        }

        function setupAdminPassword() {
            const storedPassword = localStorage.getItem('adminPasswordValue');
            if (storedPassword && storedPassword.trim().length >= 4) {
                adminPassword = storedPassword.trim();
            }
            const stored = localStorage.getItem('adminModeEnabled');
            if (stored === 'true') {
                isAdmin = true;
                showAdminAuthAlert('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”ë¨', 'success');
            }
            updateAdminCheckNote();
            updateSubjectOverviewVisibility();
        }

        function adminPasswordLogin() {
            const input = document.getElementById('adminPasswordSimple').value.trim();
            if (input === adminPassword) {
                isAdmin = true;
                localStorage.setItem('adminModeEnabled', 'true');
                showAdminAuthAlert('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”ë¨', 'success');
                if (useFirebase && database) {
                    setupFirebaseListeners();
                }
                loadStudentsData(() => loadWeekData());
                updateAdminCheckNote();
                updateSubjectOverviewVisibility();
                return;
            }
            showAdminAuthAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
        }

        function changeAdminPassword() {
            const current = document.getElementById('adminPasswordCurrent').value.trim();
            const newPass = document.getElementById('adminPasswordNew').value.trim();
            const confirmPass = document.getElementById('adminPasswordConfirm').value.trim();
            if (current !== adminPassword) {
                showAdminAuthAlert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (newPass.length < 4) {
                showAdminAuthAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            if (newPass !== confirmPass) {
                showAdminAuthAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            adminPassword = newPass;
            localStorage.setItem('adminPasswordValue', newPass);
            isAdmin = false;
            localStorage.removeItem('adminModeEnabled');
            if (currentTab < 4) {
                switchTab(4, true);
            }
            document.getElementById('adminPasswordSimple').value = '';
            document.getElementById('adminPasswordCurrent').value = '';
            document.getElementById('adminPasswordNew').value = '';
            document.getElementById('adminPasswordConfirm').value = '';
            showAdminAuthAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
            updateSubjectOverviewVisibility();
        }

        function adminLogout() {
            isAdmin = false;
            localStorage.removeItem('adminModeEnabled');
            showAdminAuthAlert('ê´€ë¦¬ì ëª¨ë“œ í•´ì œë¨', 'success');
            if (currentTab < 4) {
                switchTab(4, true);
            }
            updateAdminCheckNote();
            updateSubjectOverviewVisibility();
        }

        function resetAdminPassword() {
            if (!confirm('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë³¸ê°’(1234)ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
                return;
            }
            adminPassword = DEFAULT_ADMIN_PASSWORD;
            localStorage.setItem('adminPasswordValue', adminPassword);
            isAdmin = false;
            localStorage.removeItem('adminModeEnabled');
            if (currentTab < 4) {
                switchTab(4, true);
            }
            document.getElementById('adminPasswordSimple').value = '';
            document.getElementById('adminPasswordCurrent').value = '';
            document.getElementById('adminPasswordNew').value = '';
            document.getElementById('adminPasswordConfirm').value = '';
            showAdminAuthAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
            updateAdminCheckNote();
            updateSubjectOverviewVisibility();
        }

        function showAdminAuthAlert(message, type) {
            const alertEl = document.getElementById('adminAuthAlert');
            if (!message) {
                alertEl.className = 'auth-alert';
                alertEl.textContent = '';
                return;
            }
            alertEl.className = `auth-alert ${type === 'success' ? 'success' : 'error'}`;
            alertEl.textContent = message;
        }

        function updateAdminCheckNote() {
            const note = document.getElementById('adminCheckNote');
            if (!note) return;
            note.textContent = isAdmin
                ? 'ê´€ë¦¬ì ëª¨ë“œì…ë‹ˆë‹¤. ì²´í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
                : 'ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì²´í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        }

        function lookupStudentByCode() {
            const rawCode = document.getElementById('parentAccessCode').value.trim();
            const code = normalizeAccessCode(rawCode);
            if (!code) {
                document.getElementById('parentViewStatus').textContent = 'ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            if (!useFirebase || !database) {
                document.getElementById('parentViewStatus').textContent = 'Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                return;
            }
            database.ref(`codeIndex/${code}`).once('value')
                .then((snapshot) => {
                    const studentId = snapshot.val();
                    if (!studentId) {
                        parentViewStudents = [];
                        parentCheckedByStudent = {};
                        document.getElementById('parentViewStatus').textContent = 'ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        renderParentView();
                        return;
                    }
                    return Promise.all([
                        database.ref(`studentsById/${studentId}`).once('value'),
                        database.ref(`checkedByStudent/${studentId}`).once('value')
                    ]).then(([studentSnap, checkedSnap]) => {
                        const student = studentSnap.val();
                        if (!student) {
                            parentViewStudents = [];
                            parentCheckedByStudent = {};
                            document.getElementById('parentViewStatus').textContent = 'í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            renderParentView();
                            return;
                        }
                        parentViewStudents = [student];
                        parentCheckedByStudent = {};
                        if (checkedSnap.val()) {
                            parentCheckedByStudent[studentId] = checkedSnap.val();
                        }
                        document.getElementById('parentViewStatus').textContent = 'ì¡°íšŒ ì™„ë£Œ';
                        renderParentView();
                    });
                })
                .catch((error) => {
                    console.error('âŒ ì½”ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    document.getElementById('parentViewStatus').textContent = 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                });
        }

        function renderParentView() {
            const list = document.getElementById('parentStudentsList');
            const empty = document.getElementById('parentStudentsEmpty');
            const status = document.getElementById('parentViewStatus');
            const linkedList = document.getElementById('parentLinkedList');
            list.innerHTML = '';

            const week = document.getElementById('parentWeekSelect').value;
            if (!parentViewStudents || parentViewStudents.length === 0) {
                empty.style.display = 'block';
                empty.textContent = 'ì—°ê²°ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.';
                status.textContent = 'ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                linkedList.style.display = 'none';
                return;
            }

            empty.style.display = 'none';
            status.textContent = `${parentViewStudents.length}ëª… ì—°ê²°ë¨ Â· ${week}`;
            const linkedNames = parentViewStudents.map(s => `${s.name} (${s.grade}í•™ë…„ ${s.class})`).join(' Â· ');
            linkedList.style.display = 'block';
            linkedList.innerHTML = `<div class="auth-note">ì—°ê²°ëœ í•™ìƒ: ${linkedNames}</div>`;

            const sorted = [...parentViewStudents].sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                const classA = extractClassNumber(a.class);
                const classB = extractClassNumber(b.class);
                if (classA !== classB) return classA - classB;
                return a.num - b.num;
            });

            sorted.forEach(student => {
                const checks = (parentCheckedByStudent[student.id] && parentCheckedByStudent[student.id][week]) || {};
                const card = document.createElement('div');
                card.className = 'parent-student-card';

                const subjectsHtml = (student.subjects || []).map(subject => {
                    const checked = checks && checks[subject];
                    return `<span class="parent-subject ${checked ? 'checked' : ''}">${subject}${checked ? 'âœ“' : ''}</span>`;
                }).join('');

                card.innerHTML = `
                    <strong>${student.name}</strong> (${student.grade}í•™ë…„ ${student.class})<br>
                    <span style="color:#666; font-size:13px;">ìˆ˜ë ¹ ë°©ì‹: ${student.deliveryType || '-'}</span>
                    <div class="parent-subjects">${subjectsHtml || '<span style="color:#999;">ê³¼ëª© ì—†ìŒ</span>'}</div>
                `;

                list.appendChild(card);
            });
        }


        // ìƒˆ í•„ë“œê°€ ì—†ëŠ” í•™ìƒì— ê¸°ë³¸ê°’ ë¶€ì—¬
        function ensureNewFields() {
            let changed = false;
            const existingCodes = new Set(students.map(s => s.accessCode).filter(Boolean));
            students.forEach(s => {
                if (s.cashReceipt === undefined) {
                    s.cashReceipt = false;
                    changed = true;
                }
                if (s.mobileUrl === undefined) {
                    s.mobileUrl = false;
                    changed = true;
                }
                if (s.paymentConfirmed === undefined) {
                    s.paymentConfirmed = false;
                    changed = true;
                }
                if (s.shippingFeePaid === undefined) {
                    s.shippingFeePaid = false;
                    changed = true;
                }
                if (s.paymentAmount === undefined) {
                    s.paymentAmount = 0;
                    changed = true;
                }
                if (s.unpaidAmount === undefined) {
                    s.unpaidAmount = 0;
                    changed = true;
                }
                if (s.paymentStatus === undefined) {
                    s.paymentStatus = '';
                    changed = true;
                }
                if (!Array.isArray(s.subjects)) {
                    s.subjects = [];
                    changed = true;
                }
                if (s.deliveryType === undefined) {
                    s.deliveryType = '';
                    changed = true;
                }
                if (!s.accessCode) {
                    s.accessCode = generateAccessCode(existingCodes);
                    s.accessCodeCreatedAt = new Date().toISOString();
                    existingCodes.add(s.accessCode);
                    changed = true;
                }
                if (!s.accessCodeCreatedAt) {
                    s.accessCodeCreatedAt = new Date().toISOString();
                    changed = true;
                }
                if (isCodeExpired(s)) {
                    s.accessCode = generateAccessCode(existingCodes);
                    s.accessCodeCreatedAt = new Date().toISOString();
                    existingCodes.add(s.accessCode);
                    changed = true;
                }
                if (!Array.isArray(s.parentPhones)) {
                    s.parentPhones = s.parentPhone ? [s.parentPhone] : [];
                    changed = true;
                }
                if (!Array.isArray(s.parentPhoneKeys)) {
                    s.parentPhoneKeys = s.parentPhones.map(p => toE164Korea(p)).filter(Boolean);
                    changed = true;
                }
                if (!s.parentPhone && s.parentPhones.length > 0) {
                    s.parentPhone = s.parentPhones[0];
                    changed = true;
                }
            });
            return changed;
        }

        function normalizePhoneDigits(raw) {
            if (!raw) return '';
            const digits = String(raw).replace(/\D/g, '');
            if (!digits) return '';
            if (digits.length === 10 && !digits.startsWith('0')) {
                return '0' + digits;
            }
            return digits;
        }

        function normalizePhone(raw) {
            const digits = normalizePhoneDigits(raw);
            if (!digits) return '';

            if (digits.length === 11) {
                return digits.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            if (digits.length === 10) {
                return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            return digits;
        }

        function toE164Korea(raw) {
            const digits = String(raw || '').replace(/\D/g, '');
            if (!digits) return '';
            if (digits.startsWith('82')) return '+' + digits;
            if (digits.startsWith('0') && digits.length >= 10) return '+82' + digits.slice(1);
            return '';
        }

        function normalizeAccessCode(raw) {
            return String(raw || '').trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        function formatDateShort(date) {
            const d = new Date(date);
            if (Number.isNaN(d.getTime())) return '-';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        let ACCESS_CODE_TTL_DAYS = 30;
        let ACCESS_CODE_EXPIRING_DAYS = 7;

        function parsePaymentConfirmed(statusText, paymentAmount, unpaidAmount) {
            const text = String(statusText || '').trim().toLowerCase();
            const paidSignals = ['ì™„ë‚©', 'ì…ê¸ˆ', 'ë‚©ë¶€', 'ì™„ë£Œ', 'yes', 'y', 'o', 'ok', 'true'];
            const unpaidSignals = ['ë¯¸ë‚©', 'ë¯¸ì…ê¸ˆ', 'ë¯¸ì™„', 'no', 'n', 'x', 'false'];

            if (paidSignals.some(k => text.includes(k))) return true;
            if (unpaidSignals.some(k => text.includes(k))) return false;
            if ((paymentAmount || 0) > 0 && (unpaidAmount || 0) === 0) return true;
            return false;
        }

        function generateAccessCode(existingSet) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            if (existingSet && existingSet.has(code)) {
                return generateAccessCode(existingSet);
            }
            return code;
        }

        function isCodeExpired(student) {
            if (!student || !student.accessCodeCreatedAt) return false;
            const created = new Date(student.accessCodeCreatedAt);
            if (Number.isNaN(created.getTime())) return false;
            const expiresAt = created.getTime() + ACCESS_CODE_TTL_DAYS * 24 * 60 * 60 * 1000;
            return Date.now() > expiresAt;
        }

        function daysUntilExpiry(student) {
            if (!student || !student.accessCodeCreatedAt) return null;
            const created = new Date(student.accessCodeCreatedAt);
            if (Number.isNaN(created.getTime())) return null;
            const expiresAt = created.getTime() + ACCESS_CODE_TTL_DAYS * 24 * 60 * 60 * 1000;
            const diffMs = expiresAt - Date.now();
            return Math.ceil(diffMs / (24 * 60 * 60 * 1000));
        }

        function formatE164ToKorean(raw) {
            if (!raw) return '';
            const digits = String(raw).replace(/\D/g, '');
            if (digits.startsWith('82')) {
                return normalizePhone('0' + digits.slice(2));
            }
            return normalizePhone(digits);
        }

        function parseParentPhones(input) {
            const raw = String(input || '').split(/[,|]/).map(v => v.trim()).filter(Boolean);
            const phones = [];
            const keys = [];
            raw.forEach(value => {
                const digits = normalizePhoneDigits(value);
                const formatted = normalizePhone(value);
                const e164 = toE164Korea(digits);
                if (!digits || !formatted) return;
                if (!keys.includes(e164)) {
                    keys.push(e164);
                    phones.push(formatted);
                }
            });
            return { phones, keys };
        }

        function getStudentParentPhones(student) {
            if (student.parentPhones && Array.isArray(student.parentPhones) && student.parentPhones.length > 0) {
                return student.parentPhones;
            }
            if (student.parentPhone) return [student.parentPhone];
            return [];
        }

        function getStudentParentPhoneKeys(student) {
            if (student.parentPhoneKeys && Array.isArray(student.parentPhoneKeys) && student.parentPhoneKeys.length > 0) {
                return student.parentPhoneKeys;
            }
            const phones = getStudentParentPhones(student);
            return phones.map(p => toE164Korea(p)).filter(Boolean);
        }

        function getStudentParentPhonesDisplay(student) {
            const phones = getStudentParentPhones(student);
            return phones.length > 0 ? phones.join(', ') : '-';
        }

        function normalizeStudentPhones() {
            students.forEach(s => {
                if (s.phone) s.phone = normalizePhone(s.phone);
                if (s.parentPhone) s.parentPhone = normalizePhone(s.parentPhone);
                if (Array.isArray(s.parentPhones)) {
                    s.parentPhones = s.parentPhones
                        .map(p => normalizePhone(p))
                        .filter(Boolean);
                    s.parentPhones = [...new Set(s.parentPhones)];
                } else if (s.parentPhone) {
                    s.parentPhones = [s.parentPhone];
                } else {
                    s.parentPhones = [];
                }
                s.parentPhoneKeys = [...new Set(s.parentPhones.map(p => toE164Korea(p)).filter(Boolean))];
                if (!s.parentPhone && s.parentPhones.length > 0) {
                    s.parentPhone = s.parentPhones[0];
                }
            });
        }

        function normalizeDeliveryType(value) {
            if (!value) return '';
            const text = String(value).trim();
            if (!text) return '';
            if (text.includes('íƒë°°')) return 'íƒë°°';
            if (text.includes('í”½ì—…') || text.includes('ë°©ë¬¸') || text.includes('ìˆ˜ë ¹')) return 'í”½ì—…';
            return text;
        }

        function generateStudentId() {
            if (window.crypto && typeof window.crypto.randomUUID === 'function') {
                return `sid_${window.crypto.randomUUID()}`;
            }
            return `sid_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        }

        function ensureStudentIds() {
            let changed = false;
            students.forEach(s => {
                if (!s.id) {
                    s.id = `g${s.grade}-n${s.num}`;
                    changed = true;
                }
            });
            const idSet = new Set();
            students.forEach(s => {
                if (idSet.has(s.id)) {
                    s.id = generateStudentId();
                    changed = true;
                }
                idSet.add(s.id);
            });
            return changed;
        }

        function getStudentById(studentId) {
            return students.find(s => s.id === studentId);
        }

        function makeSafeId(value) {
            return encodeURIComponent(String(value)).replace(/%/g, '_');
        }

        function makeSubjectCheckboxId(studentId, subject) {
            return `student-${makeSafeId(studentId)}-subject-${makeSafeId(subject)}`;
        }

        function normalizeCheckValue(value, student) {
            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                return value;
            }
            if (typeof value === 'boolean') {
                const normalized = {};
                student.subjects.forEach(subject => {
                    normalized[subject] = value;
                });
                return normalized;
            }
            return {};
        }

        function normalizeCheckedStudents(data) {
            if (!data) return {};

            const normalized = {};
            const studentsById = new Map(students.map(s => [s.id, s]));
            const studentsByNum = new Map();

            students.forEach(s => {
                if (!studentsByNum.has(s.num)) studentsByNum.set(s.num, []);
                studentsByNum.get(s.num).push(s);
            });

            Object.keys(data).forEach(week => {
                const weekData = data[week] || {};
                normalized[week] = {};

                Object.keys(weekData).forEach(key => {
                    const value = weekData[key];
                    if (studentsById.has(key)) {
                        const student = studentsById.get(key);
                        normalized[week][student.id] = normalizeCheckValue(value, student);
                        return;
                    }

                    if (/^\d+$/.test(key)) {
                        const num = parseInt(key, 10);
                        const targets = studentsByNum.get(num) || [];
                        targets.forEach(student => {
                            normalized[week][student.id] = normalizeCheckValue(value, student);
                        });
                    }
                });
            });

            return normalized;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function extractClassNumber(classStr) {
            const match = classStr.match(/(\d+)/);
            return match ? parseInt(match[1]) : 999;
        }

        function getSortedStudents() {
            return [...students].sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                const classA = extractClassNumber(a.class);
                const classB = extractClassNumber(b.class);
                if (classA !== classB) return classA - classB;
                return a.name.localeCompare(b.name, 'ko');
            });
        }

        // ==================== íƒ­ 1: ë§¤ì£¼ ë°°ë¶€ ì²´í¬ ====================
        function renderStudents() {
            const grade1Body = document.getElementById('grade1Body');
            const grade2Body = document.getElementById('grade2Body');

            grade1Body.innerHTML = '';
            grade2Body.innerHTML = '';

            const sortedStudents = getSortedStudents();

            let grade1Index = 1;
            let grade2Index = 1;

            sortedStudents.forEach(student => {
                if (!Array.isArray(student.subjects)) student.subjects = [];
                const isChecked = (checkedStudents[currentWeek] && checkedStudents[currentWeek][student.id]) || {};

                if (student.grade === 1) {
                    const row = createStudentRow(student, isChecked, grade1Index);
                    grade1Body.appendChild(row);
                    grade1Index++;
                } else {
                    const row = createStudentRow(student, isChecked, grade2Index);
                    grade2Body.appendChild(row);
                    grade2Index++;
                }
            });

            updateStats();
            updateClassFilter();
            updateSubjectOverview();
        }

        function createStudentRow(student, isChecked, rowIndex) {
            if (!student.subjects) student.subjects = [];
            const tr = document.createElement('tr');
            tr.dataset.deliveryType = student.deliveryType || '';

            const allSubjectsChecked = student.subjects.length > 0 &&
                student.subjects.every(subj => isChecked && isChecked[subj]);
            if (allSubjectsChecked) tr.classList.add('completed-row');
            if (editMode) tr.classList.add('edit-mode-active');

            let subjectsHtml = '';
            if (editMode) {
                subjectsHtml = `
                    <div class="subjects ${editMode ? 'delete-mode' : ''}" id="subjects-${makeSafeId(student.id)}">
                        ${student.subjects.map(subj =>
                            `<span class="subject-tag" data-student-id="${encodeURIComponent(student.id)}" data-subject="${encodeURIComponent(subj)}">${subj}</span>`
                        ).join('')}
                        <button type="button" class="subject-picker-btn" onclick="openSubjectPicker(${JSON.stringify(student.id)})">ê³¼ëª© ì„ íƒ</button>
                        <button type="button" class="add-subject-btn" data-context="tab1" data-student-id="${encodeURIComponent(student.id)}">+ ì§ì ‘ ì¶”ê°€</button>
                    </div>
                `;
            } else {
                subjectsHtml = `
                    <div class="subjects">
                        ${student.subjects.map(subj => `<span class="subject-tag">${subj}</span>`).join('')}
                    </div>
                `;
            }

            const deleteButtonHtml = editMode
                ? `<button type="button" class="delete-student-btn" data-student-id="${encodeURIComponent(student.id)}" data-student-name="${encodeURIComponent(student.name)}">ì‚­ì œ</button>`
                : '';

            const smsButtonHtml = getStudentParentPhones(student).length > 0
                ? `<button class="sms-btn" onclick="openSMSApp(${JSON.stringify(student.id)})" title="í•™ë¶€ëª¨ì—ê²Œ ë¬¸ì ë³´ë‚´ê¸°">ë¬¸ì</button>`
                : '';

            const classHtml = `<span class="class-info editable-class" id="class-${makeSafeId(student.id)}" data-edit-class="${encodeURIComponent(student.id)}" title="í´ë¦­í•˜ì—¬ ë°˜ ìˆ˜ì •">${student.class}</span>`;

            const subjectCheckboxesHtml = student.subjects.length > 0
                ? student.subjects.map(subj => `
                    <div class="subject-checkbox-wrapper">
                        <input type="checkbox"
                               id="${makeSubjectCheckboxId(student.id, subj)}"
                               ${isChecked && isChecked[subj] ? 'checked' : ''}
                               onchange="toggleCheck(${JSON.stringify(student.id)}, ${JSON.stringify(subj)})">
                        <label for="${makeSubjectCheckboxId(student.id, subj)}">${subj}</label>
                    </div>
                `).join('')
                : '<span style="color: #999;">ê³¼ëª© ì—†ìŒ</span>';

            tr.innerHTML = `
                <td>${rowIndex}</td>
                <td class="student-name">
                    ${student.name}
                    ${deleteButtonHtml}
                    ${smsButtonHtml}
                </td>
                <td>${classHtml}</td>
                <td>${subjectsHtml}</td>
                <td><span class="editable-delivery" data-student-id="${encodeURIComponent(student.id)}" onclick="cycleDeliveryType(this)" title="í´ë¦­í•˜ì—¬ ìˆ˜ë ¹ ë°©ì‹ ë³€ê²½">${student.deliveryType || '-'}</span></td>
                <td class="phone">${student.phone || '-'}</td>
                <td class="phone">${getStudentParentPhonesDisplay(student)}</td>
                <td class="payment-amount editable-payment" data-student-id="${encodeURIComponent(student.id)}">${student.paymentAmount ? student.paymentAmount.toLocaleString() + 'ì›' : '-'}</td>
                <td style="text-align:center;">${student.paymentConfirmed ? 'âœ“' : ''}</td>
                <td class="checkbox-cell">
                    <div class="subjects-checkboxes">
                        ${subjectCheckboxesHtml}
                    </div>
                </td>
            `;

            return tr;
        }

        function toggleCheck(studentId, subject) {
            if (!checkedStudents[currentWeek]) {
                checkedStudents[currentWeek] = {};
            }
            if (!checkedStudents[currentWeek][studentId]) {
                checkedStudents[currentWeek][studentId] = {};
            }

            const checkbox = document.getElementById(makeSubjectCheckboxId(studentId, subject));
            checkedStudents[currentWeek][studentId][subject] = checkbox.checked;

            saveToLocalStorage();

            const student = getStudentById(studentId);
            if (student) {
                const row = checkbox.closest('tr');
                const allSubjectsChecked = student.subjects.every(subj =>
                    checkedStudents[currentWeek][studentId] && checkedStudents[currentWeek][studentId][subj]
                );

                if (allSubjectsChecked) {
                    row.classList.add('completed-row');
                } else {
                    row.classList.remove('completed-row');
                }
            }

            updateStats();
            showSaveIndicator();
        }

        function updateStats() {
            let totalSubjects = 0;
            let completedSubjects = 0;

            students.forEach(student => {
                totalSubjects += student.subjects.length;
                student.subjects.forEach(subject => {
                    if (checkedStudents[currentWeek] &&
                        checkedStudents[currentWeek][student.id] &&
                        checkedStudents[currentWeek][student.id][subject]) {
                        completedSubjects++;
                    }
                });
            });

            const remaining = totalSubjects - completedSubjects;
            const rate = totalSubjects > 0 ? Math.round((completedSubjects / totalSubjects) * 100) : 0;

            document.getElementById('totalCount').textContent = totalSubjects;
            document.getElementById('completedCount').textContent = completedSubjects;
            document.getElementById('remainingCount').textContent = remaining;
            document.getElementById('completionRate').textContent = rate + '%';

            let grade1TotalSubjects = 0;
            let grade1CompletedSubjects = 0;
            let grade2TotalSubjects = 0;
            let grade2CompletedSubjects = 0;

            students.forEach(student => {
                if (student.grade === 1) {
                    grade1TotalSubjects += student.subjects.length;
                    student.subjects.forEach(subject => {
                        if (checkedStudents[currentWeek] &&
                            checkedStudents[currentWeek][student.id] &&
                            checkedStudents[currentWeek][student.id][subject]) {
                            grade1CompletedSubjects++;
                        }
                    });
                } else if (student.grade === 2) {
                    grade2TotalSubjects += student.subjects.length;
                    student.subjects.forEach(subject => {
                        if (checkedStudents[currentWeek] &&
                            checkedStudents[currentWeek][student.id] &&
                            checkedStudents[currentWeek][student.id][subject]) {
                            grade2CompletedSubjects++;
                        }
                    });
                }
            });

            document.getElementById('grade1Stats').textContent = `${grade1CompletedSubjects}/${grade1TotalSubjects} ì™„ë£Œ`;
            document.getElementById('grade2Stats').textContent = `${grade2CompletedSubjects}/${grade2TotalSubjects} ì™„ë£Œ`;
        }

        const SUBJECT_CAPACITY = 25;
        let currentOverviewFilter = 'all';

        function updateSubjectOverview() {
            const filter = currentOverviewFilter;
            const filtered = filter === 'all'
                ? students
                : students.filter(s => s.deliveryType === filter);

            const grade1Subjects = {};
            const grade2Subjects = {};

            filtered.forEach(student => {
                const map = student.grade === 1 ? grade1Subjects : grade2Subjects;
                student.subjects.forEach(subj => {
                    map[subj] = (map[subj] || 0) + 1;
                });
            });

            renderSubjectBars('subjectBarsGrade1', grade1Subjects);
            renderSubjectBars('subjectBarsGrade2', grade2Subjects);
        }

        function filterSubjectOverview(type) {
            currentOverviewFilter = type;
            document.querySelectorAll('.overview-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === (type === 'all' ? 'ì „ì²´' : type));
            });
            updateSubjectOverview();
        }

        function renderSubjectBars(containerId, subjectMap) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const sorted = Object.entries(subjectMap).sort((a, b) => b[1] - a[1]);

            if (sorted.length === 0) {
                container.innerHTML = '<div style="color:#999; font-size:13px;">ì‹ ì²­ ê³¼ëª© ì—†ìŒ</div>';
                return;
            }

            container.innerHTML = sorted.map(([name, count]) => {
                const pct = Math.min((count / SUBJECT_CAPACITY) * 100, 100);
                const isFull = count >= SUBJECT_CAPACITY;
                return `
                    <div class="subject-bar-row">
                        <span class="subject-bar-name">${name}</span>
                        <div class="subject-bar-track">
                            <div class="subject-bar-fill ${isFull ? 'full' : 'open'}" style="width:${pct}%"></div>
                        </div>
                        <span class="subject-bar-count ${isFull ? 'full' : ''}">${count}/${SUBJECT_CAPACITY}${isFull ? ' ë§ˆê°' : ''}</span>
                    </div>
                `;
            }).join('');
        }

        function toggleSubjectOverview() {
            const content = document.getElementById('subjectOverviewContent');
            const toggle = document.getElementById('subjectOverviewToggle');
            content.classList.toggle('hidden');
            toggle.classList.toggle('collapsed');
        }

        function updateSubjectOverviewVisibility() {
            const el = document.getElementById('subjectOverview');
            if (el) el.style.display = isAdmin ? '' : 'none';
        }

        function cycleDeliveryType(el) {
            const studentId = decodeURIComponent(el.dataset.studentId || '');
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            const cycle = ['', 'íƒë°°', 'í”½ì—…'];
            const idx = cycle.indexOf(student.deliveryType || '');
            student.deliveryType = cycle[(idx + 1) % cycle.length];
            saveStudentsData();
            el.textContent = student.deliveryType || '-';
            if (currentTab === 5) renderTab5();
            updateSubjectOverview();
        }

        function loadWeekData() {
            currentWeek = document.getElementById('weekSelect').value;

            if (useFirebase && database && !isAdmin) {
                checkedStudents = {};
                renderStudents();
                return;
            }

            if (useFirebase && database) {
                database.ref('checkedStudents').once('value')
                    .then((snapshot) => {
                        const savedData = snapshot.val();
                        if (savedData) {
                            checkedStudents = normalizeCheckedStudents(savedData);
                        }
                        renderStudents();
                    })
                    .catch((error) => {
                        console.error("âŒ Firebase ì²´í¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                        const saved = localStorage.getItem('studentChecklist');
                        if (saved) {
                            checkedStudents = normalizeCheckedStudents(JSON.parse(saved));
                        }
                        renderStudents();
                    });
            } else {
                const saved = localStorage.getItem('studentChecklist');
                if (saved) {
                    checkedStudents = normalizeCheckedStudents(JSON.parse(saved));
                }
                renderStudents();
            }
        }

        function saveToLocalStorage() {
            if (useFirebase && database) {
                const checkedByStudent = buildCheckedByStudent(checkedStudents);
                Promise.all([
                    database.ref('checkedStudents').set(checkedStudents),
                    database.ref('checkedByStudent').set(checkedByStudent)
                ])
                .catch((error) => {
                    console.error("âŒ Firebase ì €ì¥ ì‹¤íŒ¨:", error);
                    localStorage.setItem('studentChecklist', JSON.stringify(checkedStudents));
                });
            } else {
                localStorage.setItem('studentChecklist', JSON.stringify(checkedStudents));
                localStorage.setItem('checkedByStudent', JSON.stringify(buildCheckedByStudent(checkedStudents)));
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function searchStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tab-1 tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterGrade(grade) {
            const grade1Section = document.getElementById('grade1Section');
            const grade2Section = document.getElementById('grade2Section');

            if (grade === 'all') {
                grade1Section.style.display = 'block';
                grade2Section.style.display = 'block';
            } else if (grade === 1) {
                grade1Section.style.display = 'block';
                grade2Section.style.display = 'none';
            } else if (grade === 2) {
                grade1Section.style.display = 'none';
                grade2Section.style.display = 'block';
            }

            document.getElementById('classFilter').value = 'all';
            filterByClass();
        }

        function updateClassFilter() {
            const classFilter = document.getElementById('classFilter');
            const currentValue = classFilter.value;

            const classes = [...new Set(students.map(s => s.class))].sort((a, b) => {
                return extractClassNumber(a) - extractClassNumber(b);
            });

            classFilter.innerHTML = '<option value="all">ëª¨ë“  ë°˜</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classFilter.appendChild(option);
            });

            if (classes.includes(currentValue)) {
                classFilter.value = currentValue;
            }
        }

        function filterByClass() {
            const selectedClass = document.getElementById('classFilter').value;
            const rows = document.querySelectorAll('#tab-1 tbody tr');

            rows.forEach(row => {
                const classCell = row.cells[2];
                if (!classCell) return;
                const classText = classCell.textContent.trim();

                if (selectedClass === 'all') {
                    row.style.display = '';
                } else {
                    row.style.display = classText === selectedClass ? '' : 'none';
                }
            });
        }

        function filterByDelivery() {
            const selected = document.getElementById('deliveryFilter').value;
            const rows = document.querySelectorAll('#tab-1 tbody tr');
            rows.forEach(row => {
                if (selected === 'all') {
                    row.style.display = '';
                } else {
                    row.style.display = (row.dataset.deliveryType === selected) ? '' : 'none';
                }
            });
        }

        function filterByDeliveryTab2() {
            const selected = document.getElementById('tab2DeliveryFilter').value;
            const rows = document.querySelectorAll('#tab-2 tbody tr');
            rows.forEach(row => {
                if (selected === 'all') {
                    row.style.display = '';
                } else {
                    row.style.display = (row.dataset.deliveryType === selected) ? '' : 'none';
                }
            });
        }

        function checkAll() {
            if (!checkedStudents[currentWeek]) {
                checkedStudents[currentWeek] = {};
            }
            students.forEach(student => {
                if (!checkedStudents[currentWeek][student.id]) {
                    checkedStudents[currentWeek][student.id] = {};
                }
                student.subjects.forEach(subject => {
                    checkedStudents[currentWeek][student.id][subject] = true;
                });
            });
            saveToLocalStorage();
            renderStudents();
            showSaveIndicator();
        }

        function uncheckAll() {
            if (!checkedStudents[currentWeek]) {
                checkedStudents[currentWeek] = {};
            }
            students.forEach(student => {
                if (!checkedStudents[currentWeek][student.id]) {
                    checkedStudents[currentWeek][student.id] = {};
                }
                student.subjects.forEach(subject => {
                    checkedStudents[currentWeek][student.id][subject] = false;
                });
            });
            saveToLocalStorage();
            renderStudents();
            showSaveIndicator();
        }

        function resetWeek() {
            document.getElementById('resetWarning').style.display = 'block';
        }

        function confirmReset() {
            checkedStudents[currentWeek] = {};
            saveToLocalStorage();
            renderStudents();
            document.getElementById('resetWarning').style.display = 'none';
            showSaveIndicator();
        }

        function cancelReset() {
            document.getElementById('resetWarning').style.display = 'none';
        }

        function toggleEditMode(e) {
            editMode = !editMode;
            const btn = e && e.target ? e.target : null;
            if (btn) {
                btn.textContent = editMode ? 'í¸ì§‘ ì™„ë£Œ' : 'ê³¼ëª© í¸ì§‘';
                btn.className = editMode ? 'btn btn-success' : 'btn btn-primary';
            }
            renderStudents();
        }

        function handleSubjectClick(studentId, subject) {
            if (!editMode) return;
            const student = getStudentById(studentId);
            if (student) {
                const index = student.subjects.indexOf(subject);
                if (index > -1) {
                    student.subjects.splice(index, 1);
                    saveStudentsData();
                    renderStudents();
                    showSaveIndicator();
                }
            }
        }

        function showAddSubject(studentId) {
            if (editingStudent) {
                cancelAddSubject();
            }
            editingStudent = studentId;
            const subjectsDiv = document.getElementById(`subjects-${makeSafeId(studentId)}`);
            const addBtn = subjectsDiv.querySelector('.add-subject-btn');

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'subject-input';
            input.placeholder = 'ê³¼ëª©ëª…';
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSubject(studentId, input.value);
                }
            };
            input.onblur = () => {
                setTimeout(() => {
                    if (input.value.trim()) {
                        addSubject(studentId, input.value);
                    } else {
                        cancelAddSubject();
                    }
                }, 200);
            };

            addBtn.style.display = 'none';
            subjectsDiv.appendChild(input);
            input.focus();
        }

        function addSubject(studentId, subjectName) {
            if (!subjectName.trim()) {
                cancelAddSubject();
                return;
            }
            const student = getStudentById(studentId);
            if (student && !student.subjects.includes(subjectName.trim())) {
                student.subjects.push(subjectName.trim());
                saveStudentsData();
            }
            editingStudent = null;
            renderStudents();
            showSaveIndicator();
        }

        function cancelAddSubject() {
            editingStudent = null;
            renderStudents();
        }

        function getAllSubjects() {
            const subjectSet = new Set(defaultSubjectPool);
            students.forEach(s => s.subjects.forEach(subject => subjectSet.add(subject)));
            return Array.from(subjectSet).sort((a, b) => a.localeCompare(b, 'ko'));
        }

        function openSubjectPicker(studentId) {
            const student = getStudentById(studentId);
            if (!student) return;

            currentSubjectPickerStudentId = studentId;
            const subjects = getAllSubjects();
            renderSubjectPickerList(subjects, new Set(student.subjects));
            document.getElementById('subjectPickerSearch').value = '';
            document.getElementById('customSubjectInput').value = '';
            document.getElementById('subjectPickerModal').style.display = 'block';
        }

        function closeSubjectPicker() {
            document.getElementById('subjectPickerModal').style.display = 'none';
            currentSubjectPickerStudentId = null;
        }

        function renderSubjectPickerList(subjects, selectedSet) {
            const list = document.getElementById('subjectPickerList');
            list.innerHTML = '';

            subjects.forEach(subject => {
                const label = document.createElement('label');
                label.className = 'subject-picker-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.dataset.subject = subject;
                input.checked = selectedSet.has(subject);

                const span = document.createElement('span');
                span.textContent = subject;

                label.appendChild(input);
                label.appendChild(span);
                list.appendChild(label);
            });
        }

        function filterSubjectPickerList() {
            const term = document.getElementById('subjectPickerSearch').value.trim().toLowerCase();
            document.querySelectorAll('#subjectPickerList .subject-picker-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function selectAllSubjects() {
            document.querySelectorAll('#subjectPickerList input[type="checkbox"]').forEach(input => {
                input.checked = true;
            });
        }

        function clearAllSubjects() {
            document.querySelectorAll('#subjectPickerList input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });
        }

        function addCustomSubjectToPicker() {
            const inputEl = document.getElementById('customSubjectInput');
            const newSubject = inputEl.value.trim();
            if (!newSubject) return;

            const existing = Array.from(document.querySelectorAll('#subjectPickerList input[type="checkbox"]'))
                .some(input => input.dataset.subject === newSubject);

            if (!existing) {
                const list = document.getElementById('subjectPickerList');
                const label = document.createElement('label');
                label.className = 'subject-picker-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.dataset.subject = newSubject;
                input.checked = true;

                const span = document.createElement('span');
                span.textContent = newSubject;

                label.appendChild(input);
                label.appendChild(span);
                list.appendChild(label);
            } else {
                document.querySelectorAll('#subjectPickerList input[type="checkbox"]').forEach(input => {
                    if (input.dataset.subject === newSubject) input.checked = true;
                });
            }

            inputEl.value = '';
        }

        function applySubjectPicker() {
            const student = getStudentById(currentSubjectPickerStudentId);
            if (!student) return;

            const selected = Array.from(document.querySelectorAll('#subjectPickerList input[type="checkbox"]'))
                .filter(input => input.checked)
                .map(input => input.dataset.subject);

            student.subjects = selected;
            saveStudentsData();
            renderStudents();
            if (currentTab === 3) renderTab3();
            showSaveIndicator();
            closeSubjectPicker();
        }

        document.addEventListener('click', (e) => {
            // ë°˜ ìˆ˜ì • í´ë¦­
            const classEl = e.target.closest('.editable-class');
            if (classEl && classEl.dataset.editClass) {
                const studentId = decodeURIComponent(classEl.dataset.editClass);
                const tab = classEl.dataset.tab || '';
                if (tab === 'tab2') {
                    showEditClassTab2(studentId);
                } else if (tab === 'tab3') {
                    showEditClassTab3(studentId);
                } else if (tab === 'tab5') {
                    showEditClassGeneric(studentId, renderTab5);
                } else {
                    showEditClass(studentId);
                }
                return;
            }

            const addBtn = e.target.closest('.add-subject-btn');
            if (addBtn) {
                const studentId = decodeURIComponent(addBtn.dataset.studentId || '');
                const context = addBtn.dataset.context;
                if (studentId) {
                    if (context === 'tab3') {
                        showAddSubjectTab3(studentId);
                    } else {
                        showAddSubject(studentId);
                    }
                }
                return;
            }

            const deleteBtn = e.target.closest('.delete-student-btn');
            if (deleteBtn) {
                const studentId = decodeURIComponent(deleteBtn.dataset.studentId || '');
                const studentName = decodeURIComponent(deleteBtn.dataset.studentName || '');
                if (studentId) {
                    deleteStudent(studentId, studentName || 'í•™ìƒ');
                }
                return;
            }

            const target = e.target.closest('.subject-tag');
            if (!target) return;

            const studentIdSafe = target.dataset.studentId;
            const subjectEncoded = target.dataset.subject;
            if (!studentIdSafe || !subjectEncoded) return;

            const studentId = decodeURIComponent(studentIdSafe);
            const subject = decodeURIComponent(subjectEncoded);

            if (editMode) {
                handleSubjectClick(studentId, subject);
                return;
            }
            if (editModeTab3) {
                handleSubjectClickTab3(studentId, subject);
            }
        });

        // status-toggle ì´ë²¤íŠ¸ ìœ„ì„ (Tab 2, Tab 5 í† ê¸€ ë²„íŠ¼)
        document.addEventListener('click', (e) => {
            const toggle = e.target.closest('.status-toggle[data-toggle-field]');
            if (!toggle) return;
            const field = toggle.dataset.toggleField;
            const studentId = decodeURIComponent(toggle.dataset.studentId || '');
            if (!field || !studentId) return;
            toggleStudentField(studentId, field, toggle);
        });

        // ì…ê¸ˆì•¡ í´ë¦­ í¸ì§‘
        document.addEventListener('click', (e) => {
            const cell = e.target.closest('.editable-payment');
            if (!cell || cell.querySelector('input')) return;
            const studentId = decodeURIComponent(cell.dataset.studentId || '');
            if (!studentId) return;
            const student = getStudentById(studentId);
            if (!student) return;

            const currentVal = student.paymentAmount || 0;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'class-input';
            input.style.width = '80px';
            input.value = currentVal > 0 ? currentVal : '';
            input.placeholder = 'ê¸ˆì•¡';

            const save = () => {
                const val = parseInt(input.value.replace(/[^0-9]/g, '')) || 0;
                student.paymentAmount = val;
                saveStudentsData();
                showSaveIndicator();
                cell.textContent = val > 0 ? val.toLocaleString() + 'ì›' : '-';
            };

            input.onkeypress = (e) => { if (e.key === 'Enter') { save(); input.blur(); } };
            input.onblur = () => { save(); };

            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        });

        // ë°˜ ì •ë³´ ìˆ˜ì •
        let editingClass = null;

        function showEditClass(studentId) {
            if (editingClass) cancelEditClass();
            editingClass = studentId;
            const student = getStudentById(studentId);
            if (!student) return;

            const classSpan = document.getElementById(`class-${makeSafeId(studentId)}`);
            if (!classSpan) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'class-input';
            input.value = student.class;
            input.placeholder = 'ì˜ˆ: 1ë°˜';

            input.onkeypress = (e) => {
                if (e.key === 'Enter') updateClass(studentId, input.value);
            };
            input.onblur = () => {
                setTimeout(() => {
                    if (input.value.trim() && input.value !== student.class) {
                        updateClass(studentId, input.value);
                    } else {
                        cancelEditClass();
                    }
                }, 200);
            };

            classSpan.parentNode.replaceChild(input, classSpan);
            input.focus();
            input.select();
        }

        function updateClass(studentId, newClass) {
            if (!newClass.trim()) {
                cancelEditClass();
                return;
            }
            const student = getStudentById(studentId);
            if (student) {
                student.class = newClass.trim();
                saveStudentsData();
                showSaveIndicator();
            }
            editingClass = null;
            renderStudents();
            renderTab2();
            renderTab3();
            if (currentTab === 5) renderTab5();
            updateClassFilter();
        }

        function cancelEditClass() {
            editingClass = null;
            renderStudents();
        }

        function showEditClassTab2(studentId) {
            const classSpan = document.getElementById(`class-tab2-${makeSafeId(studentId)}`);
            if (!classSpan) return;
            const student = getStudentById(studentId);
            if (!student) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'class-input';
            input.value = student.class;
            input.placeholder = 'ì˜ˆ: 1ë°˜';
            input.onkeypress = (e) => { if (e.key === 'Enter') updateClass(studentId, input.value); };
            input.onblur = () => {
                setTimeout(() => {
                    if (input.value.trim() && input.value !== student.class) {
                        updateClass(studentId, input.value);
                    } else {
                        renderTab2();
                    }
                }, 200);
            };
            classSpan.parentNode.replaceChild(input, classSpan);
            input.focus();
            input.select();
        }

        function showEditClassTab3(studentId) {
            const classSpan = document.getElementById(`class-tab3-${makeSafeId(studentId)}`);
            if (!classSpan) return;
            const student = getStudentById(studentId);
            if (!student) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'class-input';
            input.value = student.class;
            input.placeholder = 'ì˜ˆ: 1ë°˜';
            input.onkeypress = (e) => { if (e.key === 'Enter') updateClass(studentId, input.value); };
            input.onblur = () => {
                setTimeout(() => {
                    if (input.value.trim() && input.value !== student.class) {
                        updateClass(studentId, input.value);
                    } else {
                        renderTab3();
                    }
                }, 200);
            };
            classSpan.parentNode.replaceChild(input, classSpan);
            input.focus();
            input.select();
        }

        function showEditClassGeneric(studentId, renderFn) {
            const el = document.querySelector(`.editable-class[data-edit-class="${encodeURIComponent(studentId)}"]`);
            if (!el) return;
            const student = getStudentById(studentId);
            if (!student) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'class-input';
            input.value = student.class;
            input.placeholder = 'ì˜ˆ: 1ë°˜';
            input.onkeypress = (e) => { if (e.key === 'Enter') updateClass(studentId, input.value); };
            input.onblur = () => {
                setTimeout(() => {
                    if (input.value.trim() && input.value !== student.class) {
                        updateClass(studentId, input.value);
                    } else if (renderFn) {
                        renderFn();
                    }
                }, 200);
            };
            el.parentNode.replaceChild(input, el);
            input.focus();
            input.select();
        }

        // ==================== íƒ­ 2: ì‹ ì²­/ì…ê¸ˆ í˜„í™© ====================
        function renderTab2() {
            const grade1Body = document.getElementById('tab2Grade1Body');
            const grade2Body = document.getElementById('tab2Grade2Body');

            grade1Body.innerHTML = '';
            grade2Body.innerHTML = '';

            const sortedStudents = getSortedStudents();

            let grade1Index = 1;
            let grade2Index = 1;
            let grade1Count = 0;
            let grade2Count = 0;

            sortedStudents.forEach(student => {
                if (student.grade === 1) {
                    grade1Body.appendChild(createTab2Row(student, grade1Index));
                    grade1Index++;
                    grade1Count++;
                } else {
                    grade2Body.appendChild(createTab2Row(student, grade2Index));
                    grade2Index++;
                    grade2Count++;
                }
            });

            document.getElementById('tab2Grade1Stats').textContent = `${grade1Count}ëª…`;
            document.getElementById('tab2Grade2Stats').textContent = `${grade2Count}ëª…`;

            updateTab2Stats();
            updateTab2ClassFilter();
        }

        function createTab2Row(student, rowIndex) {
            if (!Array.isArray(student.subjects)) student.subjects = [];
            const tr = document.createElement('tr');
            tr.dataset.deliveryType = student.deliveryType || '';

            const subjectsHtml = student.subjects.map(subj =>
                `<span class="subject-tag">${subj}</span>`
            ).join('');

            const shippingFeeHtml = student.deliveryType === 'íƒë°°'
                ? `<div class="status-toggle ${student.shippingFeePaid ? 'checked' : ''}"
                     data-toggle-field="shippingFeePaid" data-student-id="${encodeURIComponent(student.id)}">
                     ${student.shippingFeePaid ? 'âœ“' : ''}
                   </div>`
                : '<span style="color:#999;">-</span>';

            tr.innerHTML = `
                <td>${rowIndex}</td>
                <td class="student-name">${student.name}</td>
                <td><span class="class-info editable-class" id="class-tab2-${makeSafeId(student.id)}" data-edit-class="${encodeURIComponent(student.id)}" data-tab="tab2" title="í´ë¦­í•˜ì—¬ ë°˜ ìˆ˜ì •">${student.class}</span></td>
                <td><div class="subjects">${subjectsHtml}</div></td>
                <td><span class="editable-delivery" data-student-id="${encodeURIComponent(student.id)}" onclick="cycleDeliveryType(this)" title="í´ë¦­í•˜ì—¬ ìˆ˜ë ¹ ë°©ì‹ ë³€ê²½">${student.deliveryType || '-'}</span></td>
                <td class="payment-amount editable-payment" data-student-id="${encodeURIComponent(student.id)}">${student.paymentAmount ? student.paymentAmount.toLocaleString() + 'ì›' : '-'}</td>
                <td>${shippingFeeHtml}</td>
                <td>
                    <div class="status-toggle ${student.cashReceipt ? 'checked' : ''}"
                         data-toggle-field="cashReceipt" data-student-id="${encodeURIComponent(student.id)}">
                        ${student.cashReceipt ? 'âœ“' : ''}
                    </div>
                </td>
                <td>
                    <div class="status-toggle ${student.mobileUrl ? 'checked' : ''}"
                         data-toggle-field="mobileUrl" data-student-id="${encodeURIComponent(student.id)}">
                        ${student.mobileUrl ? 'âœ“' : ''}
                    </div>
                </td>
                <td>
                    <div class="status-toggle ${student.paymentConfirmed ? 'checked' : ''}"
                         data-toggle-field="paymentConfirmed" data-student-id="${encodeURIComponent(student.id)}">
                        ${student.paymentConfirmed ? 'âœ“' : ''}
                    </div>
                </td>
            `;

            return tr;
        }

        function toggleStudentField(studentId, field, el) {
            const student = getStudentById(studentId);
            if (!student) return;

            student[field] = !student[field];

            // í† ê¸€ UI ì—…ë°ì´íŠ¸
            if (student[field]) {
                el.classList.add('checked');
                el.textContent = 'âœ“';
            } else {
                el.classList.remove('checked');
                el.textContent = '';
            }

            saveStudentsData();
            updateTab2Stats();
            if (typeof updateTab5Stats === 'function') updateTab5Stats();
            showSaveIndicator();
        }

        function updateTab2Stats() {
            const total = students.length;
            const cashReceiptCount = students.filter(s => s.cashReceipt).length;
            const mobileUrlCount = students.filter(s => s.mobileUrl).length;
            const paymentCount = students.filter(s => s.paymentConfirmed).length;
            const deliveryStudents = students.filter(s => s.deliveryType === 'íƒë°°');
            const shippingFeeCount = deliveryStudents.filter(s => s.shippingFeePaid).length;

            document.getElementById('tab2TotalCount').textContent = total;
            document.getElementById('tab2CashReceiptCount').textContent = cashReceiptCount;
            document.getElementById('tab2MobileUrlCount').textContent = mobileUrlCount;
            document.getElementById('tab2ShippingFeeCount').textContent = `${shippingFeeCount}/${deliveryStudents.length}`;
            document.getElementById('tab2PaymentCount').textContent = paymentCount;
        }

        function updateTab2ClassFilter() {
            const classFilter = document.getElementById('tab2ClassFilter');
            const currentValue = classFilter.value;

            const classes = [...new Set(students.map(s => s.class))].sort((a, b) => {
                return extractClassNumber(a) - extractClassNumber(b);
            });

            classFilter.innerHTML = '<option value="all">ëª¨ë“  ë°˜</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classFilter.appendChild(option);
            });

            if (classes.includes(currentValue)) {
                classFilter.value = currentValue;
            }
        }

        function searchStudentsTab2() {
            const searchTerm = document.getElementById('tab2SearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tab-2 tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterGradeTab2(grade) {
            const g1 = document.getElementById('tab2Grade1Section');
            const g2 = document.getElementById('tab2Grade2Section');

            if (grade === 'all') {
                g1.style.display = 'block';
                g2.style.display = 'block';
            } else if (grade === 1) {
                g1.style.display = 'block';
                g2.style.display = 'none';
            } else if (grade === 2) {
                g1.style.display = 'none';
                g2.style.display = 'block';
            }

            document.getElementById('tab2ClassFilter').value = 'all';
            filterByClassTab2();
        }

        function filterByClassTab2() {
            const selectedClass = document.getElementById('tab2ClassFilter').value;
            const rows = document.querySelectorAll('#tab-2 tbody tr');

            rows.forEach(row => {
                const classCell = row.cells[2];
                if (!classCell) return;
                const classText = classCell.textContent.trim();

                if (selectedClass === 'all') {
                    row.style.display = '';
                } else {
                    row.style.display = classText === selectedClass ? '' : 'none';
                }
            });
        }

        // ==================== íƒ­ 5: íƒë°°/í”½ì—… ê´€ë¦¬ ====================
        function renderTab5() {
            const deliveryBody = document.getElementById('tab5DeliveryBody');
            const pickupBody = document.getElementById('tab5PickupBody');
            const noneBody = document.getElementById('tab5NoneBody');
            deliveryBody.innerHTML = '';
            pickupBody.innerHTML = '';
            noneBody.innerHTML = '';

            const sortedStudents = getSortedStudents();
            let deliveryIdx = 1, pickupIdx = 1, noneIdx = 1;
            let deliveryCount = 0, pickupCount = 0, noneCount = 0;

            sortedStudents.forEach(student => {
                if (student.deliveryType === 'íƒë°°') {
                    deliveryBody.appendChild(createTab5Row(student, deliveryIdx, true));
                    deliveryIdx++;
                    deliveryCount++;
                } else if (student.deliveryType === 'í”½ì—…') {
                    pickupBody.appendChild(createTab5Row(student, pickupIdx, false));
                    pickupIdx++;
                    pickupCount++;
                } else {
                    noneBody.appendChild(createTab5Row(student, noneIdx, false));
                    noneIdx++;
                    noneCount++;
                }
            });

            document.getElementById('tab5DeliveryStats').textContent = `${deliveryCount}ëª…`;
            document.getElementById('tab5PickupStats').textContent = `${pickupCount}ëª…`;
            document.getElementById('tab5NoneStats').textContent = `${noneCount}ëª…`;

            // ë¯¸ì§€ì • ì„¹ì…˜ ìˆ¨ê¸°ê¸° (0ëª…ì´ë©´)
            document.getElementById('tab5NoneSection').style.display = noneCount > 0 ? '' : 'none';

            updateTab5Stats();
        }

        function createTab5Row(student, rowIndex, isDelivery) {
            if (!Array.isArray(student.subjects)) student.subjects = [];
            const tr = document.createElement('tr');

            const subjectsHtml = student.subjects.map(subj =>
                `<span class="subject-tag">${subj}</span>`
            ).join('') || '<span style="color:#999;">ê³¼ëª© ì—†ìŒ</span>';

            const shippingCol = isDelivery
                ? `<td>
                     <div class="status-toggle ${student.shippingFeePaid ? 'checked' : ''}"
                          data-toggle-field="shippingFeePaid" data-student-id="${encodeURIComponent(student.id)}">
                          ${student.shippingFeePaid ? 'âœ“' : ''}
                     </div>
                   </td>`
                : '';

            tr.innerHTML = `
                <td>${rowIndex}</td>
                <td class="student-name">${student.name}</td>
                <td>${student.grade}í•™ë…„</td>
                <td><span class="class-info editable-class" data-edit-class="${encodeURIComponent(student.id)}" data-tab="tab5" title="í´ë¦­í•˜ì—¬ ë°˜ ìˆ˜ì •">${student.class}</span></td>
                <td><div class="subjects">${subjectsHtml}</div></td>
                <td class="payment-amount editable-payment" data-student-id="${encodeURIComponent(student.id)}">${student.paymentAmount ? student.paymentAmount.toLocaleString() + 'ì›' : '-'}</td>
                ${shippingCol}
                <td class="phone">${getStudentParentPhonesDisplay(student)}</td>
            `;

            return tr;
        }

        function updateTab5Stats() {
            const deliveryStudents = students.filter(s => s.deliveryType === 'íƒë°°');
            const pickupStudents = students.filter(s => s.deliveryType === 'í”½ì—…');
            const shippingPaid = deliveryStudents.filter(s => s.shippingFeePaid).length;
            const shippingUnpaid = deliveryStudents.length - shippingPaid;

            document.getElementById('tab5DeliveryCount').textContent = deliveryStudents.length;
            document.getElementById('tab5PickupCount').textContent = pickupStudents.length;
            document.getElementById('tab5ShippingPaid').textContent = `${shippingPaid}/${deliveryStudents.length}`;
            document.getElementById('tab5ShippingUnpaid').textContent = shippingUnpaid;
        }

        function searchStudentsTab3() {
            const searchTerm = document.getElementById('tab3SearchInput').value.toLowerCase();
            const filter = document.getElementById('tab3CodeFilter').value;
            const rows = document.querySelectorAll('#tab-3 tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const studentId = row.dataset.studentId;
                let matchesFilter = true;
                if (studentId) {
                    const student = getStudentById(studentId);
                    if (filter === 'expired') {
                        matchesFilter = isCodeExpired(student);
                    } else if (filter === 'expiring') {
                        const remaining = daysUntilExpiry(student);
                        matchesFilter = remaining !== null && remaining <= ACCESS_CODE_EXPIRING_DAYS && remaining >= 0;
                    }
                }
                row.style.display = text.includes(searchTerm) && matchesFilter ? '' : 'none';
            });
        }

        // ==================== íƒ­ 3: í•™ìƒ ê´€ë¦¬ ====================
        function renderTab3() {
            const grade1Body = document.getElementById('tab3Grade1Body');
            const grade2Body = document.getElementById('tab3Grade2Body');

            grade1Body.innerHTML = '';
            grade2Body.innerHTML = '';

            const sortedStudents = getSortedStudents();

            let grade1Index = 1;
            let grade2Index = 1;
            let grade1Count = 0;
            let grade2Count = 0;

            sortedStudents.forEach(student => {
                if (student.grade === 1) {
                    grade1Body.appendChild(createTab3Row(student, grade1Index));
                    grade1Index++;
                    grade1Count++;
                } else {
                    grade2Body.appendChild(createTab3Row(student, grade2Index));
                    grade2Index++;
                    grade2Count++;
                }
            });

            document.getElementById('tab3StudentCount').textContent = students.length;
            document.getElementById('tab3Grade1Count').textContent = `${grade1Count}ëª…`;
            document.getElementById('tab3Grade2Count').textContent = `${grade2Count}ëª…`;
        }

        function createTab3Row(student, rowIndex) {
            if (!Array.isArray(student.subjects)) student.subjects = [];
            const tr = document.createElement('tr');
            if (editModeTab3) tr.classList.add('edit-mode-active');
            tr.dataset.studentId = student.id;

            let subjectsHtml = '';
            if (editModeTab3) {
                subjectsHtml = `
                    <div class="subjects delete-mode" id="tab3-subjects-${makeSafeId(student.id)}">
                        ${student.subjects.map(subj =>
                            `<span class="subject-tag" data-student-id="${encodeURIComponent(student.id)}" data-subject="${encodeURIComponent(subj)}">${subj}</span>`
                        ).join('')}
                        <button type="button" class="subject-picker-btn" onclick="openSubjectPicker(${JSON.stringify(student.id)})">ê³¼ëª© ì„ íƒ</button>
                        <button type="button" class="add-subject-btn" data-context="tab3" data-student-id="${encodeURIComponent(student.id)}">+ ì§ì ‘ ì¶”ê°€</button>
                    </div>
                `;
            } else {
                subjectsHtml = `
                    <div class="subjects">
                        ${student.subjects.map(subj => `<span class="subject-tag">${subj}</span>`).join('')}
                    </div>
                `;
            }

            const deleteButtonHtml = editModeTab3
                ? `<button type="button" class="delete-student-btn" style="display:inline-block;" data-student-id="${encodeURIComponent(student.id)}" data-student-name="${encodeURIComponent(student.name)}">ì‚­ì œ</button>`
                : '';

            tr.innerHTML = `
                <td>${rowIndex}</td>
                <td class="student-name">${student.name} ${deleteButtonHtml}</td>
                <td><span class="class-info editable-class" id="class-tab3-${makeSafeId(student.id)}" data-edit-class="${encodeURIComponent(student.id)}" data-tab="tab3" title="í´ë¦­í•˜ì—¬ ë°˜ ìˆ˜ì •">${student.class}</span></td>
                <td>${subjectsHtml}</td>
                <td><span class="editable-delivery" data-student-id="${encodeURIComponent(student.id)}" onclick="cycleDeliveryType(this)" title="í´ë¦­í•˜ì—¬ ìˆ˜ë ¹ ë°©ì‹ ë³€ê²½">${student.deliveryType || '-'}</span></td>
                <td class="phone">${student.phone || '-'}</td>
                <td class="phone">${getStudentParentPhonesDisplay(student)}</td>
                <td>
                    <span class="code-pill">${student.accessCode || '-'}</span>
                    <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px; margin-left:6px;" type="button"
                        onclick="copyAccessCode(${JSON.stringify(student.id)})">ë³µì‚¬</button>
                    <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px; margin-left:6px;" type="button"
                        onclick="regenerateAccessCode(${JSON.stringify(student.id)})">ì¬ìƒì„±</button>
                </td>
                <td>${(() => {
                    const remaining = daysUntilExpiry(student);
                    const expiryDate = student.accessCodeCreatedAt
                        ? formatDateShort(new Date(new Date(student.accessCodeCreatedAt).getTime() + ACCESS_CODE_TTL_DAYS * 24 * 60 * 60 * 1000))
                        : '-';
                    if (remaining !== null && remaining <= ACCESS_CODE_EXPIRING_DAYS) {
                        return `<span class="code-expiring">${expiryDate} (${remaining}ì¼)</span>`;
                    }
                    return expiryDate;
                })()}</td>
            `;

            return tr;
        }

        function toggleEditModeTab3() {
            editModeTab3 = !editModeTab3;
            renderTab3();
        }

        function handleSubjectClickTab3(studentId, subject) {
            if (!editModeTab3) return;
            const student = getStudentById(studentId);
            if (student) {
                const index = student.subjects.indexOf(subject);
                if (index > -1) {
                    student.subjects.splice(index, 1);
                    saveStudentsData();
                    renderTab3();
                    showSaveIndicator();
                }
            }
        }

        function regenerateAccessCode(studentId) {
            if (!confirm('ì ‘ì† ì½”ë“œë¥¼ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ì½”ë“œëŠ” ë” ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            const student = getStudentById(studentId);
            if (!student) return;
            const existingCodes = new Set(students.map(s => s.accessCode).filter(Boolean));
            existingCodes.delete(student.accessCode);
            student.accessCode = generateAccessCode(existingCodes);
            student.accessCodeCreatedAt = new Date().toISOString();
            saveStudentsData();
            renderTab3();
            showSaveIndicator();
        }

        function regenerateExpiredCodes() {
            if (!confirm('ë§Œë£Œëœ ì½”ë“œë§Œ ì¬ìƒì„±í• ê¹Œìš”?')) return;
            const existingCodes = new Set(students.map(s => s.accessCode).filter(Boolean));
            let changed = 0;
            students.forEach(s => {
                if (isCodeExpired(s)) {
                    existingCodes.delete(s.accessCode);
                    s.accessCode = generateAccessCode(existingCodes);
                    s.accessCodeCreatedAt = new Date().toISOString();
                    existingCodes.add(s.accessCode);
                    changed++;
                }
            });
            if (changed > 0) {
                saveStudentsData();
                renderTab3();
                showSaveIndicator();
                alert(`${changed}ëª…ì˜ ì½”ë“œê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                alert('ë§Œë£Œëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function copyAccessCode(studentId) {
            const student = getStudentById(studentId);
            if (!student || !student.accessCode) return;
            const code = student.accessCode;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showSaveIndicator();
                });
                return;
            }
            const temp = document.createElement('textarea');
            temp.value = code;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showSaveIndicator();
        }

        function showAddSubjectTab3(studentId) {
            const subjectsDiv = document.getElementById(`tab3-subjects-${makeSafeId(studentId)}`);
            const addBtn = subjectsDiv.querySelector('.add-subject-btn');

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'subject-input';
            input.placeholder = 'ê³¼ëª©ëª…';
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = input.value.trim();
                    const student = getStudentById(studentId);
                    if (student && value && !student.subjects.includes(value)) {
                        student.subjects.push(value);
                        saveStudentsData();
                        showSaveIndicator();
                    }
                    renderTab3();
                }
            };
            input.onblur = () => {
                setTimeout(() => {
                    const value = input.value.trim();
                    const student = getStudentById(studentId);
                    if (student && value && !student.subjects.includes(value)) {
                        student.subjects.push(value);
                        saveStudentsData();
                        showSaveIndicator();
                    }
                    renderTab3();
                }, 200);
            };

            addBtn.style.display = 'none';
            subjectsDiv.appendChild(input);
            input.focus();
        }

        // ==================== ì—‘ì…€ ì—…ë¡œë“œ ====================
        function setupExcelUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('excelFileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processExcelFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processExcelFile(file);
                fileInput.value = '';
            });
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« í–‰ì€ í—¤ë”, ë‘ ë²ˆì§¸ í–‰ë¶€í„° ë°ì´í„°ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    const headers = jsonData[0].map(h => String(h).trim());
                    const rows = jsonData.slice(1).filter(row => row.some(cell => cell !== undefined && cell !== ''));

                    // ì»¬ëŸ¼ ë§¤í•‘
                    const colMap = autoMapColumns(headers);

                    if (colMap.name === -1) {
                        alert('ì´ë¦„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ì— "ì´ë¦„"ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    // í•™ìƒ ë°ì´í„° íŒŒì‹±
                    const rawParsed = [];
                    const duplicates = [];
                    const invalidGrades = [];
                    const updatedExisting = [];

                    rows.forEach((row, idx) => {
                        const name = colMap.name >= 0 ? String(row[colMap.name] || '').trim() : '';
                        if (!name) return;

                        const gradeRaw = colMap.grade >= 0 ? String(row[colMap.grade] || '').trim() : '';
                        let grade = parseInt(gradeRaw.replace(/[^0-9]/g, '')) || 1;
                        if (grade !== 1 && grade !== 2) {
                            invalidGrades.push({ name, gradeRaw, rowNum: idx + 2 });
                            grade = 1;
                        }

                        const classRaw = colMap.class >= 0 ? String(row[colMap.class] || '').trim() : '';
                        const classInfo = classRaw.includes('ë°˜') ? classRaw : (classRaw ? classRaw + 'ë°˜' : '1ë°˜');

                        const subjectsRaw = colMap.subjects >= 0 ? String(row[colMap.subjects] || '').trim() : '';
                        const subjects = subjectsRaw ? subjectsRaw.split(/[,ï¼Œã€|]/).map(s => s.trim()).filter(s => s) : [];

                        const phone = colMap.phone >= 0 ? normalizePhone(row[colMap.phone]) : '';
                        const parentInput = colMap.parentPhone >= 0 ? row[colMap.parentPhone] : '';
                        const parsedParents = parseParentPhones(parentInput);
                        const parentPhones = parsedParents.phones;
                        const parentPhoneKeys = parsedParents.keys;
                        const parentPhone = parentPhones.length > 0 ? parentPhones[0] : '';
                        const deliveryType = colMap.delivery >= 0 ? normalizeDeliveryType(row[colMap.delivery]) : '';
                        const accessCode = colMap.code >= 0 ? normalizeAccessCode(row[colMap.code]) : '';

                        // ì…ê¸ˆ ê´€ë ¨ ë°ì´í„° íŒŒì‹±
                        const paymentAmount = colMap.paymentAmount >= 0
                            ? parseInt(String(row[colMap.paymentAmount] || '0').replace(/[^0-9]/g, '')) || 0 : 0;
                        const unpaidAmount = colMap.unpaidAmount >= 0
                            ? parseInt(String(row[colMap.unpaidAmount] || '0').replace(/[^0-9]/g, '')) || 0 : 0;
                        const paymentStatus = colMap.paymentStatus >= 0
                            ? String(row[colMap.paymentStatus] || '').trim() : '';
                        const paymentConfirmed = parsePaymentConfirmed(paymentStatus, paymentAmount, unpaidAmount);

                        // ì¤‘ë³µ ê°ì§€ (ì´ë¦„ + í•™ë…„ + ë°˜)
                        const isDuplicate = students.some(s =>
                            s.name === name && s.grade === grade && s.class === classInfo
                        );

                        if (isDuplicate) {
                            // ê¸°ì¡´ í•™ìƒ ì…ê¸ˆì •ë³´ ì—…ë°ì´íŠ¸
                            const existing = students.find(s => s.name === name && s.grade === grade && s.class === classInfo);
                            if (existing) {
                                if (paymentAmount > 0) {
                                    existing.paymentAmount = (existing.paymentAmount || 0) + paymentAmount;
                                }
                                if (unpaidAmount > 0) {
                                    existing.unpaidAmount = (existing.unpaidAmount || 0) + unpaidAmount;
                                }
                                if (paymentStatus) {
                                    existing.paymentStatus = paymentStatus || existing.paymentStatus || '';
                                }
                                if (paymentConfirmed) existing.paymentConfirmed = true;
                                if (paymentAmount > 0 || unpaidAmount > 0 || paymentStatus) {
                                    updatedExisting.push({ name, grade, classInfo, paymentAmount });
                                }
                            }
                            duplicates.push({ name, grade, classInfo, rowNum: idx + 2 });
                        } else {
                            rawParsed.push({
                                name, grade, class: classInfo, subjects,
                                phone, parentPhone, parentPhones, parentPhoneKeys,
                                deliveryType,
                                accessCode: accessCode,
                                cashReceipt: false, mobileUrl: false, paymentConfirmed: paymentConfirmed,
                                paymentAmount, unpaidAmount, paymentStatus
                            });
                        }
                    });

                    // ì—…ë¡œë“œ ë°ì´í„° ë‚´ ë™ì¼ í•™ìƒ(ì´ë¦„+í•™ë…„+ë°˜) í•©ì‚°
                    const mergedMap = {};
                    rawParsed.forEach(s => {
                        const key = `${s.name}_${s.grade}_${s.class}`;
                        if (mergedMap[key]) {
                            mergedMap[key].paymentAmount = (mergedMap[key].paymentAmount || 0) + (s.paymentAmount || 0);
                            mergedMap[key].unpaidAmount = (mergedMap[key].unpaidAmount || 0) + (s.unpaidAmount || 0);
                            if (s.paymentStatus) mergedMap[key].paymentStatus = s.paymentStatus;
                            // ê³¼ëª© í•©ì‚° (ì¤‘ë³µ ì œê±°)
                            s.subjects.forEach(subj => {
                                if (!mergedMap[key].subjects.includes(subj)) {
                                    mergedMap[key].subjects.push(subj);
                                }
                            });
                        } else {
                            mergedMap[key] = { ...s };
                        }
                    });
                    const parsed = Object.values(mergedMap);

                    if (parsed.length === 0 && duplicates.length === 0) {
                        alert('ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ê¸°ì¡´ í•™ìƒ ì—…ë°ì´íŠ¸ë¶„ì´ ìˆìœ¼ë©´ ì €ì¥
                    if (updatedExisting.length > 0) {
                        saveStudentsData();
                    }

                    pendingExcelStudents = parsed;
                    pendingExcelUpdatedCount = updatedExisting.length;
                    showExcelPreview(parsed, duplicates, invalidGrades, updatedExisting);

                } catch (err) {
                    console.error('Excel parse error:', err);
                    alert('íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function autoMapColumns(headers) {
            const map = { name: -1, grade: -1, class: -1, subjects: -1, phone: -1, parentPhone: -1, delivery: -1, code: -1, paymentAmount: -1, paymentStatus: -1, unpaidAmount: -1 };

            headers.forEach((h, i) => {
                const lower = h.toLowerCase();
                if (lower.includes('ì´ë¦„') || lower === 'name') map.name = i;
                else if (lower.includes('í•™ë…„') || lower === 'grade') map.grade = i;
                else if (lower.includes('ë°˜') || lower === 'class') map.class = i;
                else if (lower.includes('ê³¼ëª©') || lower === 'subject') map.subjects = i;
                else if (lower.includes('íƒë°°') || lower.includes('ë°°ì†¡') || lower.includes('ìˆ˜ë ¹') || lower.includes('í”½ì—…') || lower.includes('pickup')) map.delivery = i;
                else if (lower.includes('í•™ë¶€ëª¨') || lower.includes('ë¶€ëª¨') || lower.includes('parent')) map.parentPhone = i;
                else if (lower.includes('í•™ìƒë²ˆí˜¸') || lower.includes('í•™ìƒ ë²ˆí˜¸')) map.phone = i;
                else if (lower.includes('ì½”ë“œ') || lower.includes('ì ‘ì†') || lower.includes('access')) map.code = i;
                else if (lower.includes('ì‹¤ì œë‚¸ê¸ˆì•¡') || lower.includes('ì…ê¸ˆì•¡') || lower.includes('ë‚©ë¶€ê¸ˆ') || lower.includes('ìˆ˜ë‚©ê¸ˆ')) map.paymentAmount = i;
                else if (lower.includes('ë¯¸ë‚©') || lower.includes('ë¯¸ì…ê¸ˆ') || lower.includes('ì”ì•¡')) map.unpaidAmount = i;
                else if (lower.includes('ìˆ˜ë‚©ì—¬ë¶€') || lower.includes('ë‚©ë¶€ì—¬ë¶€') || lower.includes('ì…ê¸ˆì—¬ë¶€') || lower.includes('ì™„ë‚©')) map.paymentStatus = i;
                else if (lower.includes('ì…ê¸ˆ') && !lower.includes('ì•¡')) map.paymentStatus = i;
                else if (lower.includes('ë¯¸ë‚©')) map.unpaidAmount = i;
                else if (lower.includes('ì›ìƒ')) map.phone = i;
                else if (lower.includes('ì „í™”') || lower.includes('í•¸ë“œí°') || lower.includes('phone') || lower.includes('ì—°ë½ì²˜')) {
                    if (map.phone === -1) map.phone = i;
                    else if (map.parentPhone === -1) map.parentPhone = i;
                }
            });

            return map;
        }

        function showExcelPreview(parsed, duplicates, invalidGrades, updatedExisting) {
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('excelPreview').style.display = 'block';

            // ì¤‘ë³µ ê²½ê³ 
            const dupWarning = document.getElementById('duplicateWarning');
            const warnings = [];
            if (duplicates.length > 0) {
                warnings.push(`âš ï¸ ${duplicates.length}ëª…ì˜ ì¤‘ë³µ í•™ìƒì´ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤: ` +
                    duplicates.map(d => `${d.name}(${d.grade}í•™ë…„ ${d.classInfo})`).join(', '));
            }

            if (updatedExisting && updatedExisting.length > 0) {
                warnings.push(`â„¹ï¸ ê¸°ì¡´ í•™ìƒ ${updatedExisting.length}ëª…ì˜ ì…ê¸ˆì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤: ` +
                    updatedExisting.map(d => `${d.name}(${d.grade}í•™ë…„, +${d.paymentAmount.toLocaleString()}ì›)`).join(', '));
            }

            if (invalidGrades && invalidGrades.length > 0) {
                warnings.push(`âš ï¸ í•™ë…„ ê°’ì´ 1/2í•™ë…„ì´ ì•„ë‹Œ ${invalidGrades.length}ê±´ì„ 1í•™ë…„ìœ¼ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. (í–‰: ${invalidGrades.map(d => d.rowNum).join(', ')})`);
            }

            if (warnings.length > 0) {
                dupWarning.style.display = 'block';
                dupWarning.innerHTML = warnings.join('<br>');
            } else {
                dupWarning.style.display = 'none';
            }

            // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸”
            const hasPayment = parsed.some(s => s.paymentAmount > 0);
            let html = `<table><thead><tr>
                <th>ì´ë¦„</th><th>í•™ë…„</th><th>ë°˜</th><th>ê³¼ëª©</th><th>ìˆ˜ë ¹</th>${hasPayment ? '<th>ì…ê¸ˆì•¡</th>' : ''}<th>í•™ìƒ ì „í™”ë²ˆí˜¸</th><th>í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</th><th>ì ‘ì† ì½”ë“œ</th>
            </tr></thead><tbody>`;

            parsed.forEach(s => {
                const subjectsDisplay = s.subjects.length > 0 ? s.subjects.join(', ') : '<span style="color:#e74c3c;">ê³¼ëª© ë¯¸ë“±ë¡</span>';
                html += `<tr>
                    <td>${s.name}</td>
                    <td>${s.grade}í•™ë…„</td>
                    <td>${s.class}</td>
                    <td>${subjectsDisplay}</td>
                    <td>${s.deliveryType || '-'}</td>
                    ${hasPayment ? `<td class="payment-amount">${s.paymentAmount ? s.paymentAmount.toLocaleString() + 'ì›' : '-'}</td>` : ''}
                    <td>${s.phone || '-'}</td>
                    <td>${getStudentParentPhonesDisplay(s)}</td>
                    <td>${s.accessCode || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';

            if (parsed.length === 0) {
                html = '<p style="text-align:center; color:#999; padding:20px;">ì¶”ê°€í•  ìƒˆ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ì¤‘ë³µ).</p>';
            }

            document.getElementById('previewTableContainer').innerHTML = html;
        }

        function confirmExcelUpload() {
            if (pendingExcelStudents.length === 0 && pendingExcelUpdatedCount === 0) {
                alert('ì¶”ê°€í•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                cancelExcelUpload();
                return;
            }

            // ë²ˆí˜¸ ìë™ ìƒì„± í›„ ì¶”ê°€
            const existingCodes = new Set(students.map(s => s.accessCode).filter(Boolean));
            pendingExcelStudents.forEach(s => {
                const sameGrade = students.filter(st => st.grade === s.grade);
                const maxNum = sameGrade.length > 0 ? Math.max(...sameGrade.map(st => st.num)) : 0;
                s.num = maxNum + 1;
                s.id = generateStudentId();
                if (!s.accessCode) {
                    s.accessCode = generateAccessCode(existingCodes);
                } else {
                    s.accessCode = normalizeAccessCode(s.accessCode);
                    if (existingCodes.has(s.accessCode)) {
                        s.accessCode = generateAccessCode(existingCodes);
                    }
                }
                s.accessCodeCreatedAt = new Date().toISOString();
                existingCodes.add(s.accessCode);

                students.push(s);
            });

            students.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                return a.num - b.num;
            });

            saveStudentsData();
            renderStudents();
            renderTab2();
            renderTab3();
            showSaveIndicator();

            let msg = '';
            if (pendingExcelStudents.length > 0) {
                msg += `${pendingExcelStudents.length}ëª…ì˜ í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
            if (pendingExcelUpdatedCount > 0) {
                if (msg) msg += '\n';
                msg += `ê¸°ì¡´ í•™ìƒ ${pendingExcelUpdatedCount}ëª…ì˜ ì…ê¸ˆì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
            alert(msg || 'ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            cancelExcelUpload();
        }

        function cancelExcelUpload() {
            pendingExcelStudents = [];
            pendingExcelUpdatedCount = 0;
            document.getElementById('uploadArea').style.display = '';
            document.getElementById('excelPreview').style.display = 'none';
        }

        // ==================== ë°ì´í„° ì €ì¥/ë¡œë“œ ====================
        function buildStudentsById() {
            const map = {};
            students.forEach(s => {
                map[s.id] = {
                    id: s.id,
                    name: s.name,
                    grade: s.grade,
                    num: s.num,
                    class: s.class,
                    subjects: s.subjects || [],
                    deliveryType: s.deliveryType || '',
                    parentPhones: getStudentParentPhones(s),
                    parentPhoneKeys: getStudentParentPhoneKeys(s),
                    accessCode: s.accessCode || '',
                    accessCodeCreatedAt: s.accessCodeCreatedAt || '',
                    paymentAmount: s.paymentAmount || 0,
                    unpaidAmount: s.unpaidAmount || 0,
                    paymentStatus: s.paymentStatus || ''
                };
            });
            return map;
        }

        function buildCodeIndex() {
            const index = {};
            students.forEach(s => {
                const code = normalizeAccessCode(s.accessCode);
                if (!code) return;
                index[code] = s.id;
            });
            return index;
        }

        function buildCheckedByStudent(data) {
            const result = {};
            Object.keys(data || {}).forEach(week => {
                const weekData = data[week] || {};
                Object.keys(weekData).forEach(studentId => {
                    if (!result[studentId]) result[studentId] = {};
                    result[studentId][week] = weekData[studentId];
                });
            });
            return result;
        }

        function saveStudentsData() {
            if (useFirebase && database) {
                const studentsById = buildStudentsById();
                const codeIndex = buildCodeIndex();
                Promise.all([
                    database.ref('students').set(students),
                    database.ref('studentsById').set(studentsById),
                    database.ref('codeIndex').set(codeIndex)
                ])
                .catch((error) => {
                    console.error("âŒ Firebase ì €ì¥ ì‹¤íŒ¨:", error);
                    localStorage.setItem('studentsData', JSON.stringify(students));
                });
            } else {
                localStorage.setItem('studentsData', JSON.stringify(students));
                localStorage.setItem('studentsById', JSON.stringify(buildStudentsById()));
                localStorage.setItem('codeIndex', JSON.stringify(buildCodeIndex()));
            }
        }

        function loadStudentsData(onLoaded) {
            if (useFirebase && database && !isAdmin) {
                students.length = 0;
                checkedStudents = {};
                renderStudents();
                if (typeof onLoaded === 'function') onLoaded();
                return;
            }
            if (useFirebase && database) {
                database.ref('students').once('value')
                    .then((snapshot) => {
                        const savedData = snapshot.val();
                        if (savedData && Array.isArray(savedData)) {
                            students.length = 0;
                            students.push(...savedData);
                            const fieldsChanged = ensureNewFields();
                            normalizeStudentPhones();
                            const changed = ensureStudentIds();
                            if (fieldsChanged || changed) saveStudentsData();
                        } else {
                            students.length = 0;
                            students.push(...JSON.parse(JSON.stringify(defaultStudents)));
                            ensureNewFields();
                            normalizeStudentPhones();
                            ensureStudentIds();
                            saveStudentsData();
                        }
                        renderStudents();
                        if (typeof onLoaded === 'function') onLoaded();
                    })
                    .catch((error) => {
                        console.error("âŒ Firebase ë¡œë“œ ì‹¤íŒ¨:", error);
                        loadFromLocalStorage();
                        if (typeof onLoaded === 'function') onLoaded();
                    });
            } else {
                loadFromLocalStorage();
                if (typeof onLoaded === 'function') onLoaded();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('studentsData');
            if (saved) {
                const savedData = JSON.parse(saved);
                students.length = 0;
                students.push(...savedData);
                const fieldsChanged = ensureNewFields();
                normalizeStudentPhones();
                const changed = ensureStudentIds();
                if (fieldsChanged || changed) saveStudentsData();
            } else {
                students.length = 0;
                students.push(...JSON.parse(JSON.stringify(defaultStudents)));
                ensureNewFields();
                normalizeStudentPhones();
                ensureStudentIds();
            }
        }

        function resetToDefaultStudents() {
            if (!confirm('í•™ìƒ ë°ì´í„°ë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•œ í•™ìƒ ì •ë³´ê°€ ëª¨ë‘ ì‚¬ë¼ì§€ê³ ,\nì½”ë“œì— ì •ì˜ëœ ì´ˆê¸° í•™ìƒ ëª©ë¡ìœ¼ë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.')) {
                return;
            }

            students.length = 0;
            students.push(...JSON.parse(JSON.stringify(defaultStudents)));
            ensureNewFields();
            normalizeStudentPhones();
            ensureStudentIds();

            if (useFirebase && database) {
                const studentsById = buildStudentsById();
                Promise.all([
                    database.ref('students').set(students),
                    database.ref('studentsById').set(studentsById),
                    database.ref('codeIndex').set(buildCodeIndex())
                ])
                    .then(() => {
                        alert('í•™ìƒ ë°ì´í„°ê°€ ì´ˆê¸°ê°’ìœ¼ë¡œ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        showSaveIndicator();
                    })
                    .catch((error) => {
                        console.error("âŒ Firebase ë¦¬ì…‹ ì‹¤íŒ¨:", error);
                        alert('ë¦¬ì…‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            } else {
                localStorage.removeItem('studentsData');
                localStorage.setItem('studentsById', JSON.stringify(buildStudentsById()));
                localStorage.setItem('codeIndex', JSON.stringify(buildCodeIndex()));
                alert('í•™ìƒ ë°ì´í„°ê°€ ì´ˆê¸°ê°’ìœ¼ë¡œ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!');
                showSaveIndicator();
            }

            renderStudents();
            updateStats();
            if (currentTab === 2) renderTab2();
            if (currentTab === 3) renderTab3();
        }

        function clearAllStudents() {
            if (!confirm('ëª¨ë“  í•™ìƒ ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            students.length = 0;
            checkedStudents = {};

            if (useFirebase && database) {
                Promise.all([
                    database.ref('students').set(students),
                    database.ref('studentsById').set({}),
                    database.ref('codeIndex').set({}),
                    database.ref('checkedStudents').set(checkedStudents),
                    database.ref('checkedByStudent').set({})
                ])
                .then(() => {
                    alert('ëª¨ë“  í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    showSaveIndicator();
                })
                .catch((error) => {
                    console.error("âŒ Firebase ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:", error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            } else {
                localStorage.removeItem('studentsData');
                localStorage.removeItem('studentChecklist');
                localStorage.removeItem('studentsById');
                localStorage.removeItem('codeIndex');
                alert('ëª¨ë“  í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showSaveIndicator();
            }

            renderStudents();
            updateStats();
            if (currentTab === 2) renderTab2();
            if (currentTab === 3) renderTab3();
        }

        // ==================== í•™ìƒ ì¶”ê°€/ì‚­ì œ ====================
        function openAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
            document.getElementById('addStudentForm').reset();
        }

        window.onclick = function(event) {
            const addStudentModal = document.getElementById('addStudentModal');
            const bulkSMSModal = document.getElementById('bulkSMSModal');
            const smsModal = document.getElementById('smsModal');
            const subjectPickerModal = document.getElementById('subjectPickerModal');

            if (event.target === addStudentModal) {
                closeAddStudentModal();
            }
            if (event.target === bulkSMSModal) {
                closeBulkSMSModal();
            }
            if (event.target === smsModal) {
                closeSMSModal();
            }
            if (event.target === subjectPickerModal) {
                closeSubjectPicker();
            }
        }

        function addStudent(event) {
            event.preventDefault();

            const name = document.getElementById('studentName').value.trim();
            const grade = parseInt(document.getElementById('studentGrade').value);
            const classInfo = document.getElementById('studentClass').value.trim();
            const subjectsInput = document.getElementById('studentSubjects').value.trim();
            const deliveryType = normalizeDeliveryType(document.getElementById('studentDelivery').value.trim());
            const phone = normalizePhone(document.getElementById('studentPhone').value.trim()) || '';
            const parentPhonesInput = document.getElementById('parentPhone').value.trim();
            const accessCodeInput = normalizeAccessCode(document.getElementById('accessCode').value.trim());
            const parsedParents = parseParentPhones(parentPhonesInput);
            const parentPhones = parsedParents.phones;
            const parentPhoneKeys = parsedParents.keys;
            const parentPhone = parentPhones.length > 0 ? parentPhones[0] : '';

            const subjects = subjectsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
            const existingCodes = new Set(students.map(s => s.accessCode).filter(Boolean));
            if (accessCodeInput && existingCodes.has(accessCodeInput)) {
                alert('ì ‘ì† ì½”ë“œê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            const accessCode = accessCodeInput || generateAccessCode(existingCodes);
            const accessCodeCreatedAt = new Date().toISOString();

            const sameGradeStudents = students.filter(s => s.grade === grade);
            const maxNum = sameGradeStudents.length > 0
                ? Math.max(...sameGradeStudents.map(s => s.num))
                : 0;
            const num = maxNum + 1;

            const newStudent = {
                id: generateStudentId(),
                grade: grade,
                num: num,
                name: name,
                class: classInfo,
                subjects: subjects,
                phone: phone,
                parentPhone: parentPhone,
                parentPhones: parentPhones,
                parentPhoneKeys: parentPhoneKeys,
                accessCode: accessCode,
                accessCodeCreatedAt: accessCodeCreatedAt,
                deliveryType: deliveryType,
                cashReceipt: false,
                mobileUrl: false,
                paymentConfirmed: false
            };

            students.push(newStudent);

            students.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                return a.num - b.num;
            });

            saveStudentsData();
            renderStudents();
            updateStats();
            if (currentTab === 2) renderTab2();
            if (currentTab === 3) renderTab3();

            closeAddStudentModal();
            showSaveIndicator();
        }

        function deleteStudent(studentId, studentName) {
            if (!confirm(`${studentName} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const index = students.findIndex(s => s.id === studentId);
            if (index > -1) {
                students.splice(index, 1);

                Object.keys(checkedStudents).forEach(week => {
                    if (checkedStudents[week][studentId]) {
                        delete checkedStudents[week][studentId];
                    }
                });

                saveStudentsData();
                saveToLocalStorage();
                renderStudents();
                updateStats();
                if (currentTab === 2) renderTab2();
                if (currentTab === 3) renderTab3();
                showSaveIndicator();
            }
        }

        // ==================== ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ====================
        function downloadExcel() {
            const headers = ['í•™ë…„', 'ë²ˆí˜¸', 'ì´ë¦„', 'ë°˜', 'ì‹ ì²­ ê³¼ëª©', 'ìˆ˜ë ¹', 'ì…ê¸ˆì•¡', 'íƒë°°ë¹„ ë‚©ë¶€', 'í•™ìƒ ì „í™”ë²ˆí˜¸', 'í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸', 'ì ‘ì† ì½”ë“œ', 'ì½”ë“œ ë§Œë£Œì¼', 'í˜„ê¸ˆì˜ìˆ˜ì¦', 'ëª¨ë°”ì¼URL', 'ì…ê¸ˆí™•ì¸'];

            const sortedStudents = getSortedStudents();

            const rows = sortedStudents.map(student => {
                return [
                    student.grade + 'í•™ë…„',
                    student.num,
                    student.name,
                    student.class,
                    student.subjects.join(', '),
                    student.deliveryType || '',
                    student.paymentAmount ? student.paymentAmount.toLocaleString() : '',
                    student.deliveryType === 'íƒë°°' ? (student.shippingFeePaid ? 'O' : 'X') : '-',
                    student.phone || '',
                    getStudentParentPhonesDisplay(student),
                    student.accessCode || '',
                    student.accessCodeCreatedAt ? formatDateShort(new Date(new Date(student.accessCodeCreatedAt).getTime() + ACCESS_CODE_TTL_DAYS * 24 * 60 * 60 * 1000)) : '',
                    student.cashReceipt ? 'O' : 'X',
                    student.mobileUrl ? 'O' : 'X',
                    student.paymentConfirmed ? 'O' : 'X'
                ];
            });

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                const escapedRow = row.map(field => {
                    const fieldStr = String(field);
                    if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
                        return '"' + fieldStr.replace(/"/g, '""') + '"';
                    }
                    return fieldStr;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

            const now = new Date();
            const dateStr = now.getFullYear() +
                           String(now.getMonth() + 1).padStart(2, '0') +
                           String(now.getDate()).padStart(2, '0');
            const filename = `í•˜ëŠ˜ê³ _í•™ìƒì •ë³´_${dateStr}.csv`;

            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            showSaveIndicator();
        }

        // ==================== ë¬¸ì ë³´ë‚´ê¸° ====================
        let currentSMSStudent = null;

        function openSMSApp(studentId) {
            const student = getStudentById(studentId);
            if (!student) return;

            const parentPhones = getStudentParentPhones(student);
            if (parentPhones.length === 0) {
                alert('í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            currentSMSStudent = student;

            document.getElementById('smsStudentInfo').innerHTML = `
                <strong>${student.name}</strong> (${student.grade}í•™ë…„ ${student.class})<br>
                <span style="color: #666; font-size: 13px;">ê³¼ëª©: ${student.subjects.join(', ')}</span><br>
                <span style="color: #666; font-size: 13px;">í•™ë¶€ëª¨ ì „í™”: ${parentPhones.join(', ')}</span>
            `;

            setMessageTemplate('complete');
            document.getElementById('smsModal').style.display = 'block';
        }

        function closeSMSModal() {
            document.getElementById('smsModal').style.display = 'none';
            currentSMSStudent = null;
        }

        function setMessageTemplate(type) {
            let template = '';

            switch(type) {
                case 'complete':
                    template = `[í•˜ëŠ˜ê³  ìë£Œ ë°°ë¶€]
{ì´ë¦„} í•™ìƒì˜ ìë£Œ ë°°ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

- í•™ë…„: {í•™ë…„}í•™ë…„
- ë°˜: {ë°˜}
- ê³¼ëª©: {ê³¼ëª©}

ê°ì‚¬í•©ë‹ˆë‹¤.`;
                    break;
                case 'pickup':
                    template = `[í•˜ëŠ˜ê³  ìë£Œ ìˆ˜ë ¹ ì•ˆë‚´]
{ì´ë¦„} í•™ìƒì˜ í•™ìŠµ ìë£Œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.

- ê³¼ëª©: {ê³¼ëª©}

í•™êµì—ì„œ ìˆ˜ë ¹í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.`;
                    break;
                case 'reminder':
                    template = `[í•˜ëŠ˜ê³  ìë£Œ ìˆ˜ë ¹ ìš”ì²­]
{ì´ë¦„} í•™ìƒì˜ í•™ìŠµ ìë£Œê°€ ì•„ì§ ìˆ˜ë ¹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

- ê³¼ëª©: {ê³¼ëª©}

ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ìˆ˜ë ¹ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.`;
                    break;
                case 'custom':
                    template = '';
                    break;
            }

            document.getElementById('smsMessage').value = template;
        }

        function sendSMSFromModal() {
            if (!currentSMSStudent) return;

            let message = document.getElementById('smsMessage').value;

            message = message.replace(/\{ì´ë¦„\}/g, currentSMSStudent.name);
            message = message.replace(/\{í•™ë…„\}/g, currentSMSStudent.grade);
            message = message.replace(/\{ë°˜\}/g, currentSMSStudent.class);
            message = message.replace(/\{ê³¼ëª©\}/g, currentSMSStudent.subjects.join(', '));

            const phones = getStudentParentPhones(currentSMSStudent).map(p => p.replace(/-/g, ''));
            const recipients = phones.join(',');
            const smsUrl = `sms:${recipients}${navigator.userAgent.match(/iPhone|iPad|iPod/) ? '&' : '?'}body=${encodeURIComponent(message)}`;

            closeSMSModal();
            window.location.href = smsUrl;
        }

        function openBulkSMSModal() {
            const studentsWithParentPhone = students.filter(s => getStudentParentPhones(s).length > 0);
            const completedWithPhone = studentsWithParentPhone.filter(s => {
                if (!checkedStudents[currentWeek] || !checkedStudents[currentWeek][s.id]) return false;
                return s.subjects.every(subj => checkedStudents[currentWeek][s.id][subj]);
            });
            const incompleteWithPhone = studentsWithParentPhone.filter(s => {
                if (!checkedStudents[currentWeek] || !checkedStudents[currentWeek][s.id]) return true;
                return !s.subjects.every(subj => checkedStudents[currentWeek][s.id][subj]);
            });

            document.getElementById('allParentsCount').textContent = studentsWithParentPhone.length;
            document.getElementById('completedParentsCount').textContent = completedWithPhone.length;
            document.getElementById('incompleteParentsCount').textContent = incompleteWithPhone.length;

            document.getElementById('bulkSMSModal').style.display = 'block';
        }

        function closeBulkSMSModal() {
            document.getElementById('bulkSMSModal').style.display = 'none';
        }

        function sendBulkSMS(type) {
            let targetStudents = [];

            if (type === 'all') {
                targetStudents = students.filter(s => getStudentParentPhones(s).length > 0);
            } else if (type === 'completed') {
                targetStudents = students.filter(s => {
                    if (getStudentParentPhones(s).length === 0) return false;
                    if (!checkedStudents[currentWeek] || !checkedStudents[currentWeek][s.id]) return false;
                    return s.subjects.every(subj => checkedStudents[currentWeek][s.id][subj]);
                });
            } else if (type === 'incomplete') {
                targetStudents = students.filter(s => {
                    if (getStudentParentPhones(s).length === 0) return false;
                    if (!checkedStudents[currentWeek] || !checkedStudents[currentWeek][s.id]) return true;
                    return !s.subjects.every(subj => checkedStudents[currentWeek][s.id][subj]);
                });
            }

            if (targetStudents.length === 0) {
                alert('í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const phoneNumbers = [...new Set(targetStudents.flatMap(s => getStudentParentPhones(s).map(p => p.replace(/-/g, ''))))];

            const typeText = type === 'all' ? 'ì „ì²´' : type === 'completed' ? 'ë°°ë¶€ ì™„ë£Œ' : 'ë°°ë¶€ ë¯¸ì™„ë£Œ';
            const message = `[í•˜ëŠ˜ê³  ìë£Œ ë°°ë¶€ ì•Œë¦¼]\n${typeText} í•™ìƒë“¤ì˜ ìë£Œ ë°°ë¶€ í˜„í™©ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\nì´ ${targetStudents.length}ëª…ì˜ í•™ìƒì´ í•´ë‹¹ë©ë‹ˆë‹¤.`;

            const recipients = phoneNumbers.join(',');
            const smsUrl = `sms:${recipients}${navigator.userAgent.match(/iPhone|iPad|iPod/) ? '&' : '?'}body=${encodeURIComponent(message)}`;

            if (phoneNumbers.length > 20) {
                if (!confirm(`${phoneNumbers.length}ëª…ì—ê²Œ ë¬¸ìë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§ì€ ìˆ˜ì‹ ìì—ê²Œ í•œ ë²ˆì— ë³´ë‚´ëŠ” ê²ƒì€ ì¼ë¶€ ê¸°ê¸°ì—ì„œ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
                    return;
                }
            }

            closeBulkSMSModal();
            window.location.href = smsUrl;
        }
    </script>
</body>
</html>
